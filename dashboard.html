<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Dashboard | MDDA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-50: #f0fdfa;
            --primary-100: #ccfbf1;
            --primary-200: #99f6e4;
            --primary-300: #5eead4;
            --primary-400: #2dd4bf;
            --primary-500: #14b8a6;
            --primary-600: #0d9488;
            --primary-700: #0f766e;
            --primary-800: #115e59;
            --primary-900: #134e4a;

            /* Status Colors */
            --success: #10b981;
            --warning: #f97316;
            --danger: #ef4444;
            --info: #8b5cf6;

            /* UI Colors */
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --gradient-primary: linear-gradient(135deg, var(--primary-400), var(--primary-600));
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-secondary);
            background: linear-gradient(-45deg, #e0f2fe, #f0f9ff, #f5f3ff, #eff6ff);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: var(--text-primary);
            line-height: 1.5;
            min-height: 100vh;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Header & Navigation */
        .navbar {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 50;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            transition: all 0.3s ease;
            color: var(--text-primary);
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            cursor: pointer;
        }

        .back-button:hover {
            transform: translateX(-2px);
            background: var(--primary-50);
            border-color: var(--primary-300);
        }

        /* Main Content Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 360px 1fr;
            gap: 1.5rem;
            padding: 1.5rem;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Patient Info Card */
        .patient-card {
            background: var(--bg-primary);
            border-radius: 0.75rem;
            box-shadow: var(--shadow-md);
            padding: 1.5rem;
            transition: all 0.3s ease-out;
        }

        .patient-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
        }

        .patient-avatar {
            width: 100px;
            height: 96px;
            background: linear-gradient(135deg, var(--primary-400), var(--primary-600));
            border-radius: 50%;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: white;
            margin: 0 auto 1rem;
            font-weight: 700;
            animation: pulseGlow 3s infinite ease-in-out;
            transition: transform 0.3s ease;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .status-ready {
            background-color: rgba(34, 197, 94, 0.15);
            color: #15803d;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .status-processing {
            background-color: rgba(245, 158, 11, 0.15);
            color: #b45309;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        /* Medical Data Section */
        .data-section {
            background: var(--bg-primary);
            border-radius: 0.75rem;
            box-shadow: var(--shadow-md);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .metric-card {
            background: var(--bg-tertiary);
            border-radius: 0.5rem;
            border: 1px solid var(--border);
            padding: 1.25rem;
            transition: all 0.2s ease;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-300);
            background: var(--bg-primary);
        }

        .metric-card:hover .metric-icon {
            transform: scale(1.15);
        }

        .tab-button {
            padding: 0.75rem 1.25rem;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: transparent;
            border: 1px solid transparent;
        }

        .tab-button:hover {
            background-color: var(--primary-50);
        }

        .tab-button.active {
            color: var(--primary-600);
            background-color: var(--primary-50);
            border-color: var(--primary-200);
            border-bottom-color: var(--primary-50);
        }

        /* --- Colorful Tab Variants --- */
        .tab-button[data-tab="overview"]:hover,
        .tab-button[data-tab="overview"].active {
            color: var(--primary-700);
            background-color: var(--primary-100);
            border-color: var(--primary-300);
            border-bottom-color: var(--primary-100);
        }

        .tab-button[data-tab="labs"]:hover,
        .tab-button[data-tab="labs"].active {
            color: #15803d; /* green-800 */
            background-color: #f0fdf4; /* green-50 */
            border-color: #86efac; /* green-300 */
            border-bottom-color: #f0fdf4;
        }

        .tab-button[data-tab="imaging"]:hover,
        .tab-button[data-tab="imaging"].active {
            color: #5b21b6; /* violet-800 */
            background-color: #f5f3ff; /* violet-50 */
            border-color: #c4b5fd; /* violet-300 */
            border-bottom-color: #f5f3ff;
        }

        .tab-button[data-tab="plan"]:hover,
        .tab-button[data-tab="plan"].active {
            color: #b45309; /* amber-700 */
            background-color: #fffbeb; /* amber-50 */
            border-color: #fcd34d; /* amber-300 */
            border-bottom-color: #fffbeb;
        }

        .tab-button[data-tab="edit"].active {
            color: #b91c1c; /* red-700 */
        }

        .tab-button[data-tab="ai"]:hover,
        .tab-button[data-tab="ai"].active {
            color: #0d9488; /* teal-700 */
            background-color: #f0fdfa; /* teal-50 */
            border-color: #99f6e4; /* teal-200 */
            border-bottom-color: #f0fdfa;
        }

        .tab-button[data-tab="timeline"]:hover,
        .tab-button[data-tab="timeline"].active {
            color: #be185d; /* pink-700 */
            background-color: #fdf2f8; /* pink-50 */
            border-color: #f9a8d4; /* pink-300 */
            border-bottom-color: #fdf2f8;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.4s ease-in-out;
        }

        /* AI Summary Section */
        .ai-summary {
            background: linear-gradient(135deg, var(--primary-50), #f3f4f6);
            /* The scanning animation has been removed for a cleaner look */
            position: relative;
            transition: all 0.3s ease-out;
            border: 1px solid transparent; /* Prevents layout shift on hover */
        }

        .ai-summary:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-200);
        }

        .ai-icon {
            flex-shrink: 0;
            width: 40px;

            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary-100);
            border-radius: 0.5rem;
            color: var(--primary-600);
            animation: pulseGlow 2.5s infinite ease-in-out;
        }

        #aiSummaryText {
            font-size: 0.95rem;
            line-height: 1.6;
        }

        /* Edit Tab Styles */
        #edit-form .input-group {
            margin-bottom: 1rem;
        }
        #edit-form input, #edit-form textarea {
            width: 100%;
            padding: 0.5rem; border: 1px solid var(--border); border-radius: 0.375rem;
        }

        /* Lab Results Table Hover */
        #labResultsTable tbody tr {
            transition: background-color 0.2s ease, transform 0.2s ease;
            border-left: 3px solid transparent;
        }

        #labResultsTable tbody tr:hover {
            background-color: var(--primary-100);
            border-radius: 0.25rem;
        }

        .sparkline-cell {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sparkline-cell svg {
            stroke-width: 2.5;
        }

        /* Charts and Visualizations */
        .chart-container {
            background: var(--bg-primary);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-top: 1.5rem;
            box-shadow: var(--shadow-md);
            position: relative;
        }

        /* Sortable Table Headers */
        #labResultsTable th {
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        #labResultsTable th .sort-indicator {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
        }
        /* Additional Visual Elements */
        .divider {
            height: 1px;
            background: var(--border);
            margin: 1rem 0;
        }

        .info-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }

        .info-value {
            color: var(--text-primary);
            font-weight: 500;
            }

            /* Workflow Steps */
            .workflow-step {
                position: relative;
                padding: 1rem;
                border-radius: 0.5rem;
                border: 1px solid transparent;
                background: var(--bg-tertiary);
                transition: all 0.3s ease;
            }

            .workflow-step::before {
                content: '';
                position: absolute;
                left: 0;
                bottom: 0;
                height: 3px;
                width: 0;
                width: 100%;
                background: var(--primary-500);
                transition: width 0.5s ease;
                transform: scaleX(0);
                transform-origin: left; 
                transition: transform 0.5s ease, background-color 0.3s ease;
            }

            .workflow-step.completed::before, .workflow-step.active::before {
                transform: scaleX(1);
            }

            /* Processing Animation */
            .processing-indicator {
                display: inline-block;
                width: 12px;
                height: 12px;
                border-radius: 50%;
                margin-right: 8px;
                animation: pulse 1.5s infinite;
            }

            @keyframes pulse {
                0% { transform: scale(0.95); opacity: 0.5; }
                50% { transform: scale(1.05); opacity: 0.8; }
                100% { transform: scale(0.95); opacity: 0.5; }
            }

            @keyframes pulseGlow {
                0%, 100% { box-shadow: 0 0 10px rgba(14, 165, 233, 0.2); }
                50% { box-shadow: 0 0 20px rgba(14, 165, 233, 0.4); }
            }

            .status-processing .processing-indicator {
                background-color: var(--primary-500);
                animation: pulse 1.5s infinite;
            }
            .workflow-step.active .processing-indicator {
                background-color: var(--primary-500);
                animation: pulse 1.5s infinite;
            }

            .status-completed .processing-indicator {
                background-color: var(--success);
                animation: none;
            }

            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }

            /* Animations */
            .animate-fadeInUp {
                animation: fadeInUp 0.5s ease-out forwards;
                opacity: 0;
            }

            @keyframes fadeInUp {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
            }

            /* Definition Modal */
            .modal-backdrop {
                position: fixed;
                top: 0; left: 0; width: 100%; height: 100%;
                background-color: rgba(30, 41, 59, 0.8);
                backdrop-filter: blur(4px);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                opacity: 0;
                visibility: hidden;
                transition: opacity 0.3s ease, visibility 0.3s ease;
            }
            .modal-backdrop.visible {
                opacity: 1;
                visibility: visible;
            }
            .modal-container {
                background: var(--bg-primary);
                padding: 2rem;
                border-radius: 0.75rem;
                width: 90%;
                max-width: 600px;
                box-shadow: var(--shadow-lg);
                transform: scale(0.95);
                transition: transform 0.3s ease;
            }
            .modal-backdrop.visible .modal-container {
                transform: scale(1);
            }
            .medical-term-link {
                color: var(--primary-600);
                font-weight: 600;
                text-decoration: underline;
                text-decoration-style: dotted;
                cursor: pointer;
            }
            
            /* Organ Diagram Styles */
            .organ-diagram-container {
                background-color: var(--bg-tertiary);
                border: 1px solid var(--border);
                border-radius: 0.75rem;
                padding: 1.5rem;
                margin-bottom: 1.5rem;
            }
            .organ-diagram-svg {
                max-width: 300px;
                margin: 0 auto;
                display: block;
            }
            .organ-path {
                fill: #d1d5db; /* gray-300 */
                stroke: #9ca3af; /* gray-400 */
                stroke-width: 1.5;
                transition: all 0.4s ease-in-out;
            }
            .organ-path.affected {
                fill: var(--danger);
                stroke: #991b1b; /* red-800 */
                stroke-width: 2;
                animation: pulseAffected 1.5s infinite ease-in-out;
                cursor: pointer;
            }
            .organ-label {
                font-size: 10px;
                fill: var(--text-secondary);
                font-weight: 500;
                pointer-events: none;
            }
            @keyframes pulseAffected {
                0%, 100% { opacity: 1; transform: scale(1); }
                50% { opacity: 0.8; transform: scale(1.02); }
            }

            /* Treatment Plan Styles */
            .plan-card {
                background-color: var(--bg-tertiary);
                border: 1px solid var(--border);
                border-radius: 0.75rem;
                padding: 1.5rem;
            }
            .plan-card-title {
                display: flex;
                align-items: center;
                gap: 0.75rem;
                font-size: 1.125rem;
                font-weight: 600;
                color: var(--text-primary);
                margin-bottom: 1rem;
            }
            .plan-card-title svg {
                flex-shrink: 0;
                color: var(--primary-600);
            }
            .medication-item, .consult-item {
                display: flex;
                justify-content: space-between;
                padding: 0.75rem 0;
                border-bottom: 1px solid var(--border);
            }
            .medication-item:last-child, .consult-item:last-child {
                border-bottom: none;
            }
            .medication-name, .consult-specialty {
                font-weight: 500;
            }
            .medication-purpose, .consult-status {
                font-size: 0.875rem;
                color: var(--text-secondary);
            }
            .consult-status.completed { color: var(--success); }
            .consult-status.scheduled { color: var(--warning); }
            .monitoring-list li {
                padding-left: 1.5rem;
                position: relative;
            }
            .monitoring-list li::before {
                content: '›';
                position: absolute;
                left: 0;
                font-weight: 700;
                color: var(--primary-500);
            }

            /* Image Viewer Modal Styles */
            #image-viewer-modal .modal-container {
                max-width: 90vw;
                max-height: 95vh;
                background-color: #111827; /* gray-900 */
                padding: 1rem;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }
            #modal-image-content {
                max-width: 100%;
                max-height: calc(95vh - 80px); /* Adjust for padding and caption */
                object-fit: contain;
                margin: auto;
                cursor: grab;
                transition: transform 0.2s ease-out;
                transform-origin: 0 0;
                will-change: transform;
            }
            .image-card img {
                cursor: pointer;
            }


            /* Toast Notification */
            #toast-container {
                position: fixed;
                bottom: 20px;
                right: 20px;
                z-index: 1000;
            }
            .toast {
                background-color: #2d3748;
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 0.5rem;
                box-shadow: var(--shadow-lg);
                display: flex;
                align-items: center;
                gap: 0.75rem;
                opacity: 0;
                transform: translateY(20px);
                transition: opacity 0.3s ease, transform 0.3s ease;
            }

            /* Timeline Styles */
            .timeline {
                position: relative;
                padding: 1rem 0;
                list-style: none;
            }
            .timeline::before {
                content: '';
                position: absolute;
                top: 0;
                left: 19.5px; /* (42px icon width - 3px line width) / 2 */
                height: 100%;
                width: 3px;
                background: var(--border);
                border-radius: 3px;
            }
            .timeline-item {
                margin-bottom: 2rem;
                position: relative;
                padding-left: 50px;
            }
            .timeline-icon {
                position: absolute;
                left: 0; /* Aligns the icon's left edge */
                top: 0.25rem; /* Vertically centers the icon against the text */
                width: 42px;
                height: 42px;
                border-radius: 50%;
                background: var(--surface);
                border: 3px solid var(--border);
                display: flex;
                align-items: center;
                justify-content: center;
                color: var(--primary-600);
            }
            .timeline-date { font-weight: 600; color: var(--primary-700); margin-bottom: 0.25rem; }
            .timeline-content {
                background: var(--bg-tertiary);
                padding: 1rem; border-radius: 0.5rem;
            }
            .toast.show {
                opacity: 1;
                transform: translateY(0);
            }
            .delay-1 { animation-delay: 0.15s; }
            .delay-2 { animation-delay: 0.3s; }
            .delay-3 { animation-delay: 0.45s; }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            .dashboard-grid {
                padding: 0.75rem;
            }
            .data-section, .patient-card {
                padding: 1rem;
            }
            h1 { font-size: 1.125rem; }
        }

        /* Print Styles */
        @media print {
            body { background: none; }
            .navbar, .patient-card:not(.print-header), .tab-button, .organ-diagram-container, #edit-form button, .modal-backdrop { display: none !important; }
            .dashboard-grid { display: block; }
            main { box-shadow: none; }
            .data-section, .plan-card { box-shadow: none; border: 1px solid #ccc; }
            .tab-content { display: block !important; animation: none; }
            .print-header { display: block !important; }
            a { text-decoration: none; color: inherit; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container mx-auto flex items-center p-4">
            <button onclick="window.location.href='patients.html'" class="back-button flex items-center gap-2 text-gray-600 hover:text-gray-900 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                <span class="font-medium hidden sm:inline">Back to Patients</span>
            </button>
            <h1 class="text-lg sm:text-xl font-bold ml-2 sm:ml-4 text-gray-800 flex-grow truncate">Multi-Modal Diagnostic Dashboard</h1>
            <button onclick="window.print()" class="back-button flex items-center gap-2 text-gray-600 hover:text-gray-900 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                <span class="hidden sm:inline">Print Report</span>
            </button>
        </div>
    </nav>

    <div class="dashboard-grid">
        <!-- Patient Information Sidebar -->
        <aside>
            <!-- This is a simplified header for printing -->
            <div class="patient-card print-header hidden print:block mb-6"></div>
            <div class="patient-card animate-fadeInUp mb-6 hover:scale-105 transition-transform duration-300 relative print:hidden">
                <div class="patient-avatar" id="patientInitials">SK</div>
                <div class="text-center mb-4">
                    <h2 class="text-xl font-bold mb-1" id="patientName">Sarah Kim</h2>
                    <p class="text-sm text-gray-500 mb-2" id="patientId">ID: P-2025-001</p>
                    <span id="analysisStatus" class="status-badge status-processing">
                        <span class="processing-indicator"></span>
                        Analysis Complete
                    </span>
                </div>
                <div class="divider"></div>
                <div class="space-y-4">
                    <div>
                        <div class="info-label">Age</div>
                        <div class="info-value" id="patientAge">54 years</div>
                    </div>
                    <div>
                        <div class="info-label">Gender</div>
                        <div class="info-value" id="patientGender">Female</div>
                    </div>
                    <div>
                        <div class="info-label">Blood Type</div>
                        <div class="info-value" id="patientBloodType">A+</div>
                    </div>
                    <div>
                        <div class="info-label">Height</div>
                        <div class="info-value" id="patientHeight">165 cm</div>
                    </div>
                    <div>
                        <div class="info-label">Weight</div>
                        <div class="info-value" id="patientWeight">62 kg</div>
                    </div>
                </div>
            </div>

            <div class="patient-card animate-fadeInUp delay-1 mb-6 hover:scale-105 transition-transform duration-300 print:hidden">
                <h3 class="text-lg font-semibold mb-4">Primary Diagnosis</h3>
                <div class="space-y-2">
                    <div class="info-label">Condition</div>
                    <div class="info-value" id="diagnosisCondition">Hepatocellular Carcinoma</div>
                    <div class="info-label mt-3">Date</div>
                    <div class="info-value" id="diagnosisDate">Sept 28, 2025</div>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main>
            <!-- Tab Navigation -->
            <div class="border-b border-gray-200 mb-6 animate-fadeInUp overflow-x-auto">
                <nav class="-mb-px flex space-x-2 whitespace-nowrap" aria-label="Tabs">
                    <button class="tab-button active" data-tab="overview">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16v16H4z"/><path d="M9 9h6v6H9z"/><path d="M9 1v3m6-3v3M9 20v3m6-3v3M1 9h3m-3 6h3M20 9h3m-3 6h3"/></svg>
                        Overview
                    </button>
                    <button class="tab-button" data-tab="ai">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0-6 6v6a6 6 0 0 0 6 6 6 6 0 0 0 6-6V9a6 6 0 0 0-6-6Z"/><path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/><path d="M19 10h.01"/><path d="M19 14h.01"/><path d="M5 10h.01"/><path d="M5 14h.01"/></svg>
                        AI Insights
                    </button>
                    <button class="tab-button" data-tab="timeline">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 6v6l4 2"/><circle cx="12" cy="12" r="10"/></svg>
                        Timeline
                    </button>
                    <button class="tab-button" data-tab="labs">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>
                        Lab Results
                    </button>
                    <button class="tab-button" data-tab="imaging">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="m21 15-5-5L5 21"/></svg>
                        Imaging
                    </button>
                    <button class="tab-button" data-tab="plan">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="m10.4 12.6-1.8.7 1.8.7-1.8.7"/><path d="m15.6 12.6-1.8.7 1.8.7-1.8.7"/></svg>
                        Treatment Plan
                    </button>
                    <button class="tab-button" data-tab="edit" title="Edit Patient Records">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                        Edit Records
                    </button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div id="tab-overview" class="tab-content active">
                <!-- Organ Diagram -->
                <div class="organ-diagram-container animate-fadeInUp" style="animation-delay: 0.1s;">
                    <div class="relative">
                        <h3 class="text-lg font-semibold mb-4 text-center">Affected Organ System</h3>
                        <svg id="organ-diagram" class="organ-diagram-svg" viewBox="0 0 200 300" xmlns="http://www.w3.org/2000/svg">
                            <title>Organ Diagram</title>
                            <!-- Brain -->
                            <path id="organ-brain" class="organ-path" d="M100,10 C50,10 40,45 60,50 C70,55 130,55 140,50 C160,45 150,10 100,10 M70,15 C60,20 60,35 70,40 M130,15 C140,20 140,35 130,40 M100,10 C90,20 110,20 100,10 M100,50 C90,40 110,40 100,50" />
                            <!-- Thyroid -->
                            <path id="organ-thyroid" class="organ-path" d="M90,62 C85,60 85,68 90,66 L110,66 C115,68 115,60 110,62 C105,60 95,60 90,62Z" />
                            <!-- Lungs -->
                            <path id="organ-lung-left" class="organ-path" d="M95,70 C60,70 50,100 60,140 C70,160 95,155 95,130Z" />
                            <path id="organ-lung-right" class="organ-path" d="M105,70 C140,70 150,100 140,140 C130,160 105,155 105,130Z" />
                            <!-- Heart -->
                            <path id="organ-heart" class="organ-path" d="M100,85 C90,75 75,85 80,100 C85,120 100,135 100,135 C100,135 115,120 120,100 C125,85 110,75 100,85Z" />
                            <!-- Liver -->
                            <path id="organ-liver" class="organ-path" d="M145,150 C155,160 150,180 140,190 C100,205 65,195 60,175 C55,155 90,145 120,150Z" />
                            <!-- Stomach -->
                            <path id="organ-stomach" class="organ-path" d="M70,155 C50,155 45,170 60,185 C75,200 100,195 105,180 C110,165 90,155 70,155Z" />
                            <!-- Spleen -->
                            <path id="organ-spleen" class="organ-path" d="M55,195 C45,200 45,215 55,220 C65,225 70,210 60,200Z" />
                            <!-- Pancreas -->
                            <path id="organ-pancreas" class="organ-path" d="M135,195 C145,200 140,215 130,220 C100,225 75,220 70,210Z" />
                            <!-- Kidneys -->
                            <path id="organ-kidney-left" class="organ-path" d="M85,210 C70,215 65,230 75,245 C85,255 95,245 90,230 C85,215 85,210 85,210Z" />
                            <path id="organ-kidney-right" class="organ-path" d="M115,210 C130,215 135,230 125,245 C115,255 105,245 110,230 C115,215 115,210 115,210Z" />
                            <!-- Intestines -->
                            <path id="organ-intestines" class="organ-path" d="M80,255 C70,255 70,285 80,285 L120,285 C130,285 130,255 120,255 C110,265 90,265 80,255 M85,260 C95,270 105,270 115,260 M85,275 C95,280 105,280 115,275" />
                            <!-- Breast Areas (for context) -->
                            <circle id="organ-breast-left" class="organ-path" cx="80" cy="100" r="25" fill-opacity="0.1" stroke-dasharray="2 2" />
                            <circle id="organ-breast-right" class="organ-path" cx="120" cy="100" r="25" fill-opacity="0.1" stroke-dasharray="2 2" />
                    </svg>
                        <div id="organ-info-box" class="mt-4 p-3 bg-white rounded-lg border border-gray-200 text-center min-h-[60px] flex items-center justify-center transition-all duration-200">
                            <span class="text-gray-500 italic">Hover over an organ to see details</span>
                        </div>

                    </div>
                </div>

                <!-- Vitals and Key Metrics -->
                <div class="data-section animate-fadeInUp" style="animation-delay: 0.2s">
                    <!-- Analysis Workflow Status -->
                    <div class="mb-6">
                        <h4 class="text-sm font-medium text-gray-700 mb-3">Analysis Progress</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="workflow-step" data-step="nlp">
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">NLP Processing</span>
                                    <span class="processing-indicator"></span>
                                </div>
                                <p class="mt-2 text-sm text-gray-600">Extracting data from medical reports</p>
                            </div>
                            <div class="workflow-step" data-step="fusion">
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">Data Fusion</span>
                                    <span class="processing-indicator"></span>
                                </div>
                                <p class="mt-2 text-sm text-gray-600">Combining multiple data sources</p>
                            </div>
                            <div class="workflow-step" data-step="analysis">
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">AI Analysis</span>
                                    <span class="processing-indicator"></span>
                                </div>
                                <p class="mt-2 text-sm text-gray-600">Generating diagnostic insights</p>
                            </div>
                        </div>
                    </div>

                    <!-- Key Health Metrics -->
                    <h3 class="text-lg font-semibold mb-4">Key Health Metrics</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="metric-card">
                            <div class="flex items-center gap-4">
                                <div class="metric-icon text-2xl text-red-500 transition-transform"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg></div>
                                <div>
                                    <div class="info-label">Blood Pressure</div>
                                    <div class="text-xl md:text-2xl font-semibold text-gray-900" id="bp">120/80</div>
                                </div>
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="flex items-center gap-4">
                                <div class="metric-icon text-2xl text-blue-500 transition-transform"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg></div>
                                <div>
                                    <div class="info-label">Heart Rate</div>
                                    <div class="text-xl md:text-2xl font-semibold text-gray-900" id="heartRate">72 bpm</div>
                                </div>
                            </div>
                        </div>
                        <div class="metric-card">
                             <div class="flex items-center gap-4">
                                <div class="metric-icon text-2xl text-orange-500 transition-transform"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 4v10.54a4 4 0 1 1-4 0V4a2 2 0 0 1 4 0z"></path></svg></div>
                                <div>
                                    <div class="info-label">Temperature</div>
                                    <div class="text-xl md:text-2xl font-semibold text-gray-900" id="temperature">36.8°C</div>
                                </div>
                            </div>
                        </div>
                </div>
                </div>
            </div>

            <div id="tab-ai" class="tab-content">
                <!-- AI Summary Section -->
                <div class="data-section ai-summary animate-fadeInUp mb-6">
                    <div class="flex items-start gap-4">
                        <div class="ai-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0-6 6v6a6 6 0 0 0 6 6 6 6 0 0 0 6-6V9a6 6 0 0 0-6-6Z"/><path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/><path d="M19 10h.01"/><path d="M19 14h.01"/><path d="M5 10h.01"/><path d="M5 14h.01"/></svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-primary-800">AI-Powered Diagnostic Synthesis</h3>
                        </div>
                    </div>
                    <div class="divider mt-4 mb-4"></div>
                    
                    <div class="space-y-6">
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-2">Narrative Summary</h4>
                            <p id="aiKeyFindings" class="text-gray-700 leading-relaxed">Synthesizing data...</p>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-2">Clinical Reasoning & Differential</h4>
                            <p id="aiDifferential" class="text-gray-700 leading-relaxed italic">Evaluating possibilities...</p>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-2">Actionable Recommendations</h4>
                            <p id="aiNextSteps" class="text-gray-700 leading-relaxed">Formulating recommendations...</p>
                        </div>
                    </div>

                    <div class="divider mt-4 mb-4"></div>
                    <div class="flex justify-between items-center">
                         <h4 class="font-semibold text-gray-600">Prognosis Outlook</h4>
                         <div id="aiPrognosis" class="font-bold text-lg">MODERATE RISK</div>
                    </div>
                </div>
            </div>

            <div id="tab-labs" class="tab-content">
                <!-- Lab Results -->
                <div class="data-section animate-fadeInUp">
                    <h3 class="text-lg font-semibold mb-4">Latest Lab Results</h3>
                    <div class="overflow-x-auto">
                        <table id="labResultsTable" class="min-w-full table-auto">
                            <thead class="print:hidden">
                                <tr class="bg-gray-50 text-left text-sm font-medium text-gray-500">
                                    <th class="px-4 py-2">Biomarker / Test <span class="sort-indicator"></span></th>
                                    <th class="px-4 py-2 text-right">Result <span class="sort-indicator"></span></th>
                                    <th class="px-4 py-2 text-center">Trend (3 mo)</th>
                                    <th class="px-4 py-2">Range <span class="sort-indicator"></span></th>
                                    <th class="px-4 py-2">Status <span class="sort-indicator"></span></th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-imaging" class="tab-content">
                <!-- Medical Images -->
                <div class="data-section animate-fadeInUp p-4 sm:p-6">
                    <h3 class="text-lg font-semibold mb-4">Medical Imaging</h3>
                    <div id="imaging-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="image-card bg-gray-800 rounded-lg p-2 text-center shadow-lg transition-all duration-300 hover:shadow-2xl hover:scale-[1.03]">
                            <img src="mri.jpeg" alt="MRI of Abdomen" class="w-full rounded-md aspect-square object-cover">
                            <div class="text-sm text-gray-300 mt-2 font-medium">MRI Abdomen (Coronal T2) - Oct 10, 2025</div>
                        </div>
                        <div class="image-card bg-gray-800 rounded-lg p-2 text-center shadow-lg transition-all duration-300 hover:shadow-2xl hover:scale-[1.03]">
                            <img src="WhatsApp Image 2025-10-17 at 08.19.53.jpeg" alt="MRI of Abdomen" class="w-full rounded-md aspect-square object-cover">
                            <div class="text-sm text-gray-300 mt-2 font-medium">MRI Abdomen (Coronal T2, Detail) - Oct 10, 2025</div>
                        </div>
                        <div class="image-card bg-gray-800 rounded-lg p-2 text-center shadow-lg transition-all duration-300 hover:shadow-2xl hover:scale-[1.03]">
                            <img src="pet.jpeg" alt="PET Scan" class="w-full rounded-md aspect-square object-cover">
                            <div class="text-sm text-gray-300 mt-2 font-medium">PET/CT Fusion Scan - Oct 12, 2025</div>
                        </div>
                        <div class="image-card bg-gray-800 rounded-lg p-2 text-center shadow-lg transition-all duration-300 hover:shadow-2xl hover:scale-[1.03]">
                            <img src="WhatsApp Image 2025-10-17 at 08.29.39.jpeg" alt="Chest X-Ray" class="w-full rounded-md aspect-square object-cover">
                            <div class="text-sm text-gray-300 mt-2 font-medium">Chest X-Ray (PA View) - Oct 01, 2025</div>
                        </div>
                        <div class="image-card bg-gray-800 rounded-lg p-2 text-center shadow-lg transition-all duration-300 hover:shadow-2xl hover:scale-[1.03]">
                            <img src="WhatsApp Image 2025-10-17 at 08.34.57.jpeg" alt="Brain MRI" class="w-full rounded-md aspect-square object-cover">
                            <div class="text-sm text-gray-300 mt-2 font-medium">Brain MRI (Axial FLAIR) - Sep 25, 2025</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-plan" class="tab-content">
                <!-- Treatment Plan -->
                <div class="data-section animate-fadeInUp">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Medications -->
                        <div class="plan-card lg:col-span-2">
                            <h4 class="plan-card-title">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="3" width="12" height="2" rx="1"></rect><path d="M12 5v10"></path><path d="M18 8a6 6 0 0 1-6 6h0a6 6 0 0 1-6-6V8"></path><path d="M12 15v6"></path></svg>
                                Medications
                            </h4>
                            <div id="medications-list" class="divide-y divide-gray-200"></div>
                        </div>
                        <!-- Consultations -->
                        <div class="plan-card">
                            <h4 class="plan-card-title">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                                Consultations
                            </h4>
                            <div id="consultations-list"></div>
                        </div>
                        <!-- Monitoring -->
                        <div class="plan-card">
                            <h4 class="plan-card-title">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.54 15H17a2 2 0 0 0-2 2v4.54"></path><path d="M7 3.34V5a3 3 0 0 0 3 3v0a3 3 0 0 0 3-3V3.34"></path><path d="M12 20.66V19a3 3 0 0 0-3-3v0a3 3 0 0 0-3 3v1.66"></path><path d="M4.46 9H9a2 2 0 0 0 2-2V2.46"></path><path d="M15 2.46V7a2 2 0 0 0 2 2h4.54"></path><path d="M12 12v0a3 3 0 0 0 3-3V7.83"></path><path d="M10.17 12v0a3 3 0 0 1-3 3H3.34"></path></svg>
                                Monitoring Plan
                            </h4>
                            <ul id="monitoring-list" class="space-y-2 text-gray-700 monitoring-list">
                                <!-- Monitoring items will be populated here -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-edit" class="tab-content">
                <div class="data-section animate-fadeInUp">
                    <h3 class="text-lg font-semibold mb-4">Edit Clinical Records</h3>
                    <form id="edit-form">
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-700 mb-3">Key Health Metrics (Vitals)</h4>
                            <div id="editable-vitals" class="space-y-3"></div>
                        </div>
                        <div class="divider"></div>
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-700 mb-3">Lab Results</h4>
                            <div id="editable-labs" class="space-y-3"></div>
                        </div>
                        <div class="divider"></div>
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-700 mb-3">Treatment Plan</h4>
                            <textarea id="editable-treatment" rows="4" class="w-full p-2 border rounded"></textarea>
                        </div>
                        <div class="flex gap-4 mt-6">
                            <button type="submit" class="flex-grow p-3 bg-blue-500 text-white font-bold rounded-lg hover:bg-blue-600 transition-colors">Save Changes</button>
                            <button type="button" id="reset-edit-form" class="flex-grow p-3 bg-gray-500 text-white font-bold rounded-lg hover:bg-gray-600 transition-colors">Reset to Original</button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="tab-timeline" class="tab-content">
                <div class="data-section animate-fadeInUp">
                    <h3 class="text-lg font-semibold mb-4">Patient Clinical Timeline</h3>
                    <ul id="clinical-timeline" class="timeline">
                        <!-- Timeline items will be populated here -->
                    </ul>
                </div>
            </div>

        </main>
    </div>
    
    <!-- Image Viewer Modal -->
    <div id="image-viewer-modal" class="modal-backdrop">
        <div class="modal-container relative">
            <button id="image-modal-close-btn" class="absolute top-2 right-4 text-white text-4xl font-bold hover:text-gray-300 z-10">&times;</button>
            <div class="flex-grow flex items-center justify-center">
                <img id="modal-image-content" src="" alt="Enlarged medical image" />
            </div>
            <div id="modal-image-caption" class="text-center text-gray-300 mt-2 font-medium"></div>
        </div>
    </div>

    <!-- Organ Detail Modal -->
    <div id="organ-detail-modal" class="modal-backdrop">
        <div class="modal-container">
            <div class="flex justify-between items-start">
                <h3 id="organ-modal-title" class="text-2xl font-bold mb-4 text-primary-700">Organ Details</h3>
                <button id="organ-modal-close-btn-x" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div id="organ-modal-content" class="space-y-3 text-gray-600">
                <!-- Details will be populated here -->
            </div>
            <button id="organ-modal-close-btn" class="mt-6 w-full p-3 bg-gray-200 text-gray-700 font-bold rounded-lg hover:bg-gray-300 transition-colors">Close</button>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-save-modal" class="modal-backdrop">
        <div class="modal-container">
            <h3 class="text-2xl font-bold mb-4 text-primary-700">Confirm Changes</h3>
            <p class="mb-4 text-gray-600">Please review the changes you are about to save:</p>
            <div id="changes-summary" class="space-y-2 text-sm p-4 bg-gray-50 rounded-lg max-h-60 overflow-y-auto border border-gray-200">
                <!-- Changes will be populated here -->
            </div>
            <div class="flex gap-4 mt-6">
                <button id="confirm-save-btn" class="flex-grow p-3 bg-blue-500 text-white font-bold rounded-lg hover:bg-blue-600 transition-colors">Confirm & Save</button>
                <button id="cancel-save-btn" class="flex-grow p-3 bg-gray-500 text-white font-bold rounded-lg hover:bg-gray-600 transition-colors">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Lab Chart Modal -->
    <div id="lab-chart-modal" class="modal-backdrop">
        <div class="modal-container">
            <div class="flex justify-between items-start">
                <h3 id="lab-chart-title" class="text-2xl font-bold mb-4 text-primary-700">Biomarker Trend</h3>
                <button id="lab-chart-close-btn-x" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
            </div>
            <canvas id="lab-chart-canvas"></canvas>
            <button id="lab-chart-close-btn" class="mt-6 w-full p-3 bg-gray-200 text-gray-700 font-bold rounded-lg hover:bg-gray-300 transition-colors">Close</button>
        </div>
    </div>

    <!-- Definition Modal -->
    <div id="definition-modal" class="modal-backdrop">
        <div class="modal-container">
            <h3 id="modal-term" class="text-2xl font-bold mb-4 text-primary-700">Term</h3>
            <p id="modal-definition" class="text-gray-600 leading-relaxed">Definition will appear here.</p>
            <button id="modal-close-btn" class="mt-6 w-full p-3 bg-gray-200 text-gray-700 font-bold rounded-lg hover:bg-gray-300 transition-colors">Close</button>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container"></div>

    <script>
        (function() {
            const medicalGlossary = {
                'surgical consultation': 'A meeting with a surgeon to discuss the possibility of surgery as a treatment option, including its risks and benefits.',
                'triple-phase ct scan': 'A specific type of CT scan that takes images of the liver at three different times after a contrast dye is injected. It helps to characterize liver lesions.',
                'pet scan': 'Positron Emission Tomography. An imaging test that uses a radioactive substance to look for disease in the body, often used to detect cancer spread.',
                'cisplatin/pemetrexed': 'A common combination chemotherapy regimen used to treat certain types of cancer, particularly non-small cell lung cancer and mesothelioma.',
                'hormone therapy': 'Treatment that adds, blocks, or removes hormones to slow or stop the growth of cancer cells that use hormones to grow, such as certain breast and prostate cancers.',
                'tamoxifen': 'A type of hormone therapy used to treat and prevent breast cancer. It works by blocking the effects of estrogen in breast tissue.',
                'aromatase inhibitor': 'A class of drugs used in the treatment of breast cancer in postmenopausal women. They work by blocking the production of estrogen.',
                'brca1/2 testing': 'Genetic tests that look for harmful mutations in the BRCA1 and BRCA2 genes, which are linked to an increased risk of breast, ovarian, and other cancers.',
                'endocrinologist': 'A medical doctor who specializes in diagnosing and treating disorders of the endocrine system (the glands and hormones of the body), such as diabetes and thyroid disease.',
                'continuous glucose monitoring (cgm)': 'A device that tracks glucose levels throughout the day and night, providing real-time data to help manage diabetes.',
                'lisinopril': 'A medication of the ACE inhibitor class used to treat high blood pressure, heart failure, and after heart attacks. It is also used for renal protection in some patients.',
                'nsaids': 'Nonsteroidal Anti-Inflammatory Drugs. A class of drugs that reduce pain, fever, and inflammation. Examples include ibuprofen and naproxen. They should be used with caution in patients with kidney disease.'
            };

            /**
             * Main initialization function.
             */
            async function main() {
                try {
                    const urlParams = new URLSearchParams(window.location.search);
                    const patientId = urlParams.get('id');
                    if (!patientId) {
                        console.error("Patient ID not found in URL.");
                        document.body.innerHTML = '<div class="text-center p-10">Error: Patient ID is missing. Please return to the patient directory.</div>';
                        return;
                    }

                    const patient = await fetchPatientData(patientId);
                    if (patient) {
                        updatePatientInfo(patient);
                        updateAnalysisStatus(patient.analysisStatus);
                        updateLabResults(patient.diagnosis.labResults);
                        updateOrganDiagram(patient.diagnosis.affectedOrgan);
                        updateTreatmentPlan(patient.diagnosis.treatmentPlan);
                    setupWorkflowHandlers(patient.analysisStatus);
                        updateTimeline(patient);
                        setupOrganTooltips(patient);
                        setupOrganModal(patient);
                        makeTableSortable(document.getElementById('labResultsTable'));
                        setupTabs();
                        setupImageViewer();
                        setupLabChartModal(patient);
                        setupEditTab(patient);
                        setupDefinitionModal();
                    }
                } catch (error) {
                    console.error("Failed to initialize dashboard:", error);
                }
            }

            /**
             * Simulates fetching patient data from an API.
             * @param {string} patientId The ID of the patient to fetch.
             * @returns {Promise<object>} A promise that resolves to the patient data.
             */
            function fetchPatientData(patientId) {
                const PATIENT_DB_KEY = 'mddaPatientDatabase';
                const localDB = JSON.parse(localStorage.getItem(PATIENT_DB_KEY) || '{}');

                // Prioritize localStorage
                if (localDB[patientId]) {
                    console.log("Loading patient from localStorage DB.");
                    return Promise.resolve(localDB[patientId]);
                }

                // Fallback to mock data if not in localStorage
                console.warn(`Patient ${patientId} not in localStorage. Falling back to mock data.`);
                const mockPatientData = { // This now serves as a fallback/default dataset
                    'P-2025-001': {
                        // ... existing mock data for P-2025-001
                    },
                    'P-2025-001': {
                        id: 'P-2025-001', name: 'Sarah Kim', initials: 'SK', age: 54, gender: 'Female', bloodType: 'A+', height: '165 cm', weight: '62 kg',
                        analysisStatus: 'processing',
                        diagnosis: {
                            condition: 'Hepatocellular Carcinoma', details: '5.2cm tumor, Segment VI', date: 'Sept 28, 2025',
                            affectedOrgan: 'liver',
                            aiKeyFindings: "This 54-year-old female presents a clinical picture highly indicative of Hepatocellular Carcinoma (HCC). The most significant finding is a markedly elevated Alpha-Fetoprotein (AFP) level of 420 ng/mL, which is a strong tumor marker for HCC. This is corroborated by imaging studies that identify a distinct 5.2cm lesion in segment VI of the liver. Encouragingly, her liver function appears to be well-preserved at this time, as evidenced by normal Albumin and Total Bilirubin levels.",
                            aiDifferential: "While metastatic disease from another primary cancer is always a consideration for a solitary liver lesion, it is less probable here given the absence of a known primary tumor elsewhere and the strong AFP signal. Benign possibilities such as a hepatic adenoma are also considered highly unlikely in the context of such a high AFP level, which is not typically associated with adenomas.",
                            aiPrognosis: { risk: "Moderate", color: "orange" },
                            aiNextSteps: "The immediate priority is to arrange a surgical consultation to evaluate the feasibility of resection, which offers the best curative potential. To aid the surgical planning, a triple-phase CT scan is strongly recommended. This will provide critical details about the lesion's vascularity and its relationship to major blood vessels, which is essential for determining resectability.",
                            labResults: { 
                                'Alpha-Fetoprotein (AFP)': { 
                                    value: '420 ng/mL', range: '< 10 ng/mL', status: 'High',
                                    history: [120, 250, 380, 420]
                                },
                                'Albumin': { value: '3.8 g/dL', range: '3.5-5.0 g/dL', status: 'Normal' },
                                'Total Bilirubin': { 
                                    value: '1.1 mg/dL', range: '0.3-1.2 mg/dL', status: 'Normal'
                                },
                                'ALT': { value: '55 U/L', range: '7-56 U/L', status: 'High',
                                    history: [0.8, 0.9, 1.0, 1.1]
                                } 
                            },
                            vitals: { bp: '120/80', heartRate: '72 bpm', temperature: '36.8°C' },
                            treatment: 'Surgical resection planned',
                            treatmentPlan: {
                                medications: [
                                    { name: 'Lactulose', dosage: '30ml PO BID', purpose: 'To prevent hepatic encephalopathy' },
                                    { name: 'Vitamin K', dosage: '10mg IV daily', purpose: 'To correct coagulopathy pre-op' }
                                ],
                                consultations: [
                                    { specialty: 'Surgical Oncology', date: 'Oct 15, 2025', status: 'Completed' },
                                    { specialty: 'Anesthesiology', date: 'Oct 18, 2025', status: 'Scheduled' }
                                ],
                                monitoring: ['Weekly LFTs and coagulation profile', 'Monitor for signs of ascites or edema', 'Post-op imaging at 1 and 3 months']
                            }
                        }
                    }
                    ,
                    'P-2025-002': {
                        id: 'P-2025-002', name: 'Robert Martinez', initials: 'RM', age: 67, gender: 'Male', bloodType: 'O-', height: '178 cm', weight: '85 kg',
                        analysisStatus: 'processing',
                        diagnosis: {
                            condition: 'NSCLC (Adenocarcinoma)', details: '2.8cm RUL nodule, Stage IIB', date: 'Oct 02, 2025',
                            affectedOrgan: 'lung-right',
                            aiKeyFindings: "The patient, a 67-year-old male, has a confirmed 2.8cm nodule in the right upper lobe, identified via imaging. The diagnosis of Non-Small Cell Lung Cancer (NSCLC), specifically adenocarcinoma, is supported by an elevated Carcinoembryonic Antigen (CEA) level of 15 ng/mL. Additionally, the patient's lab work reveals a mild but notable anemia, indicated by a low hemoglobin level, which may be related to the chronic disease process.",
                            aiDifferential: "Infectious causes, such as a tuberculoma or a fungal granuloma, can mimic a solitary lung nodule on imaging. However, the presence of an elevated CEA tumor marker significantly raises the suspicion for malignancy and makes these infectious etiologies less likely. The combination of the imaging finding and the specific biomarker profile provides a strong basis for the current diagnosis.",
                            aiPrognosis: { risk: "High", color: "red" },
                            aiNextSteps: "It is appropriate to proceed with the planned systemic treatment using a Cisplatin/Pemetrexed chemotherapy regimen. To complete the staging workup and ensure there is no distant disease, a PET scan is highly recommended. This will help confirm that the cancer is confined to the chest. Furthermore, the patient's hemoglobin should be closely monitored, and iron supplementation should be considered to manage the anemia.",
                            labResults: { 
                                'CEA': { value: '15 ng/mL', range: '< 5 ng/mL', status: 'High', history: [4, 8, 11, 15] }, 
                                'Hemoglobin': { value: '13.1 g/dL', range: '13.5-17.5 g/dL', status: 'Low', history: [14.5, 14.0, 13.5, 13.1] }, 
                                'Creatinine': { value: '1.0 mg/dL', range: '0.7-1.3 mg/dL', status: 'Normal' },
                                'LDH': { value: '250 U/L', range: '140-280 U/L', status: 'Normal' }
                            },
                            vitals: { bp: '135/85', heartRate: '80 bpm', temperature: '37.0°C' },
                            treatment: 'Chemotherapy (Cisplatin/Pemetrexed)',
                            treatmentPlan: {
                                medications: [
                                    { name: 'Cisplatin', dosage: '75 mg/m²', purpose: 'Cycle 1 of 4' },
                                    { name: 'Pemetrexed', dosage: '500 mg/m²', purpose: 'Cycle 1 of 4' },
                                    { name: 'Ondansetron', dosage: '8mg PO PRN', purpose: 'For nausea' }
                                ],
                                consultations: [
                                    { specialty: 'Radiation Oncology', date: 'Oct 25, 2025', status: 'Scheduled' }
                                ],
                                monitoring: ['Monitor CBC and renal function before each cycle', 'Follow-up CT scan after 2 cycles to assess response']
                            }
                        }
                    },
                    'P-2025-003': {
                        id: 'P-2025-003', name: 'Emily Johnson', initials: 'EJ', age: 42, gender: 'Female', bloodType: 'B+', height: '160 cm', weight: '58 kg',
                        analysisStatus: 'complete',
                        diagnosis: {
                            condition: 'Breast Cancer', details: 'IDC, Grade II, T2N1M0', date: 'Aug 15, 2025',
                            affectedOrgan: 'breast-left',
                            aiKeyFindings: "This 42-year-old female has a biopsy-confirmed diagnosis of Invasive Ductal Carcinoma. The tumor's biological profile is favorable, being Estrogen Receptor (ER)-positive and HER2-negative, which opens the door for effective hormone therapy. The elevated CA 15-3 tumor marker is consistent with the tumor burden. The clinical stage, T2N1M0, indicates a localized tumor with involvement of nearby lymph nodes but, crucially, no evidence of distant metastasis.",
                            aiDifferential: "With a definitive biopsy result, a differential diagnosis is not applicable. The focus shifts entirely from diagnosis to treatment planning based on the established pathology and staging.",
                            aiPrognosis: { risk: "Low", color: "green" },
                            aiNextSteps: "The recommended course of action is multi-faceted, beginning with a lumpectomy to remove the tumor, followed by adjuvant radiation to reduce the risk of local recurrence. Given the ER-positive status, initiating hormone therapy (such as Tamoxifen or an Aromatase Inhibitor) is critical. Additionally, offering genetic counseling and considering BRCA1/2 testing would be prudent to assess for hereditary cancer risk.",
                            labResults: { 
                                'CA 15-3': { value: '45 U/mL', range: '< 30 U/mL', status: 'High', history: [25, 30, 38, 45] }, 
                                'Estrogen Receptor': { value: 'Positive', range: 'N/A', status: 'Positive' }, 
                                'HER2/neu': { value: 'Negative', range: 'N/A', status: 'Negative' },
                                'Alkaline Phosphatase': { value: '110 U/L', range: '44-147 U/L', status: 'Normal' }
                            },
                            vitals: { bp: '118/75', heartRate: '68 bpm', temperature: '36.7°C' },
                            treatment: 'Lumpectomy followed by radiation and hormone therapy',
                            treatmentPlan: {
                                medications: [
                                    { name: 'Tamoxifen', dosage: '20mg PO daily', purpose: 'Adjuvant hormone therapy' }
                                ],
                                consultations: [
                                    { specialty: 'Radiation Oncology', date: 'Sep 10, 2025', status: 'Completed' },
                                    { specialty: 'Medical Oncology', date: 'Sep 15, 2025', status: 'Completed' }
                                ],
                                monitoring: ['Annual mammogram', 'Regular follow-up with medical oncology']
                            }
                        }
                    },
                    'P-2025-004': {
                        id: 'P-2025-004', name: 'Amira Lee', initials: 'AL', age: 29, gender: 'Female', bloodType: 'AB+', height: '170 cm', weight: '65 kg',
                        analysisStatus: 'processing',
                        diagnosis: {
                            condition: 'Type 1 Diabetes', details: 'HbA1c: 8.2%, Insulin Therapy', date: 'Jan 20, 2024',
                            affectedOrgan: 'pancreas',
                            aiKeyFindings: "This 29-year-old female's data points clearly to a diagnosis of Type 1 Diabetes with suboptimal glycemic control. The HbA1c of 8.2% reflects a high average blood sugar over the past three months. The core issue is confirmed by a very low C-Peptide level (0.1 ng/mL), which signifies that her pancreas is producing minimal to no insulin on its own. This is further supported by a high fasting glucose reading of 150 mg/dL.",
                            aiDifferential: "The possibility of Type 2 Diabetes is effectively ruled out by the C-Peptide result. In Type 2 Diabetes, especially in its earlier stages, C-Peptide levels are often normal or even high as the body tries to overcome insulin resistance. The extremely low level seen here is the classic hallmark of autoimmune beta-cell destruction that defines Type 1 Diabetes.",
                            aiPrognosis: { risk: "Chronic/Managed", color: "blue" },
                            aiNextSteps: "To improve management, a consultation with an endocrinologist is strongly recommended to fine-tune her insulin pump settings. The implementation of a continuous glucose monitoring (CGM) system would be a game-changer, providing invaluable real-time data to guide therapy. A referral to a registered dietitian is also crucial to reinforce skills in carbohydrate counting and meal planning.",
                            labResults: { 
                                'HbA1c': { value: '8.2%', range: '< 5.7%', status: 'High', history: [7.5, 7.8, 8.0, 8.2] }, 
                                'Fasting Glucose': { value: '150 mg/dL', range: '70-100 mg/dL', status: 'High', history: [130, 145, 140, 150] }, 
                                'C-Peptide': { value: '0.1 ng/mL', range: '0.5-2.0 ng/mL', status: 'Low', history: [0.3, 0.2, 0.1, 0.1] },
                                'GAD Antibodies': { value: 'Positive', range: 'Negative', status: 'High' }
                            },
                            vitals: { bp: '110/70', heartRate: '75 bpm', temperature: '36.9°C' },
                            treatment: 'Insulin pump therapy and continuous glucose monitoring',
                            treatmentPlan: {
                                medications: [
                                    { name: 'Insulin Aspart', dosage: 'Via pump, variable', purpose: 'Basal and bolus insulin' }
                                ],
                                consultations: [
                                    { specialty: 'Endocrinologist', date: 'Nov 05, 2024', status: 'Scheduled' },
                                    { specialty: 'Registered Dietitian', date: 'Nov 12, 2024', status: 'Scheduled' }
                                ],
                                monitoring: ['Review CGM data weekly', 'Quarterly HbA1c checks', 'Annual kidney and eye screening']
                            }
                        }
                    },
                    'P-2025-005': {
                        id: 'P-2025-005', name: 'Jasper Singh', initials: 'JS', age: 36, gender: 'Male', bloodType: 'O+', height: '182 cm', weight: '78 kg',
                        analysisStatus: 'complete',
                        diagnosis: {
                            condition: 'Asthma', details: 'Mild persistent, Inhaler therapy', date: 'Mar 10, 2023',
                            affectedOrgan: 'lungs',
                            aiKeyFindings: "This patient has an established diagnosis of mild persistent asthma that appears to be well-managed. His baseline lung function is good, with an FEV1 within the normal predicted range. The normal eosinophil count suggests that his asthma is either non-allergic in nature or that any allergic component is being effectively controlled by his current medication. Most importantly, the patient's self-reported symptom control is effective.",
                            aiDifferential: "As this is a long-standing and stable diagnosis, a differential diagnosis is not currently warranted. The clinical picture is entirely consistent with well-controlled asthma.",
                            aiPrognosis: { risk: "Very Low", color: "green" },
                            aiNextSteps: "The primary recommendation is to continue the current successful treatment plan. It is important to reinforce the patient's understanding of the need for consistent daily use of his Fluticasone inhaler to manage underlying inflammation, rather than relying solely on the rescue inhaler. Providing him with an updated, clear Asthma Action Plan for how to handle any potential flare-ups is also advised.",
                            labResults: { 
                                'FEV1': { value: '85% predicted', range: '>80% predicted', status: 'Normal' }, 
                                'Eosinophils': { value: '250 cells/mcL', range: '< 500 cells/mcL', status: 'Normal' },
                                'Total IgE': { value: '120 IU/mL', range: '< 100 IU/mL', status: 'High' }
                            },
                            vitals: { bp: '125/80', heartRate: '65 bpm', temperature: '36.6°C' },
                            treatment: 'Albuterol inhaler (as needed), Fluticasone (daily)',
                            treatmentPlan: {
                                medications: [
                                    { name: 'Fluticasone', dosage: '1 puff BID', purpose: 'Controller medication' },
                                    { name: 'Albuterol', dosage: '2 puffs PRN', purpose: 'Rescue medication' }
                                ],
                                consultations: [
                                    { specialty: 'Pulmonology', date: 'Mar 10, 2024', status: 'Completed' }
                                ],
                                monitoring: ['Annual spirometry testing', 'Review inhaler technique at each visit']
                            }
                        }
                    },
                    'P-2025-006': {
                        id: 'P-2025-006', name: 'Maria Blanco', initials: 'MB', age: 61, gender: 'Female', bloodType: 'A-', height: '155 cm', weight: '70 kg',
                        analysisStatus: 'processing',
                        diagnosis: {
                            condition: 'Chronic Kidney Disease', details: 'Stage 3, eGFR: 45', date: 'Jul 22, 2025',
                            affectedOrgan: 'kidneys',
                            aiKeyFindings: "This 61-year-old female's lab results indicate Stage 3 Chronic Kidney Disease (CKD). This is defined by her estimated Glomerular Filtration Rate (eGFR) of 45 mL/min/1.73m². The diagnosis is further substantiated by elevated levels of Serum Creatinine and BUN, both of which confirm reduced kidney function. Her co-existing hypertension (140/90 mmHg) is significant, as it is both a potential cause and a consequence of her kidney disease.",
                            aiDifferential: "The diagnosis points towards a chronic process. While an Acute Kidney Injury (AKI) is a possibility, it is less likely given the context. To be certain, a review of her historical creatinine levels is recommended to confirm a gradual decline in function over time, which is characteristic of CKD rather than a sudden drop seen in AKI.",
                            aiPrognosis: { risk: "Moderate", color: "orange" },
                            aiNextSteps: "Management should focus on slowing disease progression. It is crucial to continue Lisinopril, as it provides both blood pressure control and a protective effect on the kidneys. A referral to a renal dietitian is essential for counseling on a diet low in sodium and potassium. The patient must be educated to strictly avoid NSAIDs, which can further harm the kidneys. A follow-up lab panel in 3 months is necessary to monitor the eGFR trend.",
                            labResults: { 
                                'eGFR': { value: '45 mL/min/1.73m²', range: '>90', status: 'Low', history: [55, 50, 48, 45] }, 
                                'Serum Creatinine': { value: '1.5 mg/dL', range: '0.6-1.1 mg/dL', status: 'High', history: [1.2, 1.3, 1.4, 1.5] }, 
                                'BUN': { value: '25 mg/dL', range: '7-20 mg/dL', status: 'High', history: [20, 22, 24, 25] },
                                'UACR': { value: '50 mg/g', range: '< 30 mg/g', status: 'High' }
                            },
                            vitals: { bp: '140/90', heartRate: '78 bpm', temperature: '36.8°C' },
                            treatment: 'Lisinopril for blood pressure control, dietary restrictions',
                            treatmentPlan: {
                                medications: [
                                    { name: 'Lisinopril', dosage: '20mg PO daily', purpose: 'Blood pressure & renal protection' },
                                    { name: 'Atorvastatin', dosage: '40mg PO daily', purpose: 'Cardiovascular risk reduction' }
                                ],
                                consultations: [
                                    { specialty: 'Nephrology', date: 'Oct 20, 2025', status: 'Scheduled' },
                                    { specialty: 'Renal Dietitian', date: 'Aug 10, 2025', status: 'Completed' }
                                ],
                                monitoring: ['Monitor eGFR and electrolytes every 3 months', 'Maintain BP < 130/80 mmHg']
                            }
                        }
                    },
                    'P-2025-007': {
                        id: 'P-2025-007', name: 'David Chen', initials: 'DC', age: 48, gender: 'Male', bloodType: 'B-', height: '175 cm', weight: '72 kg',
                        analysisStatus: 'complete',
                        diagnosis: {
                            condition: 'Glioblastoma',
                            details: '4.5cm mass in left temporal lobe',
                            date: 'Oct 18, 2025',
                            affectedOrgan: 'brain',
                            aiKeyFindings: "A 48-year-old male presents with a 4.5cm ring-enhancing mass in the left temporal lobe, identified on contrast-enhanced MRI. The imaging characteristics are highly suggestive of a high-grade glioma, most likely Glioblastoma (GBM). The patient's recent onset of seizures and headaches aligns with the location and size of the lesion. Lab work is largely unremarkable, which is common in primary brain tumors.",
                            aiDifferential: "While the primary differential is Glioblastoma, other possibilities include a solitary brain metastasis from an unknown primary cancer or, less likely, a primary CNS lymphoma. However, the ring-enhancement and surrounding edema on MRI strongly favor GBM. An abscess is also a remote possibility but is less likely without signs of systemic infection.",
                            aiPrognosis: { risk: "High", color: "red" },
                            aiNextSteps: "Immediate neurosurgical consultation is paramount for biopsy and maximal safe resection of the tumor. Post-operative chemoradiation with temozolomide is the standard of care and should be planned. Genetic analysis of the tumor tissue for MGMT promoter methylation status is critical for prognostic and treatment planning.",
                            labResults: {
                                'CBC': { value: 'Normal', range: 'N/A', status: 'Normal' },
                                'CMP': { value: 'Normal', range: 'N/A', status: 'Normal' },
                                'GFAP': { value: 'Elevated', range: 'N/A', status: 'High', history: [1,1,1,1] },
                                'CRP': { value: '0.5 mg/L', range: '< 3.0 mg/L', status: 'Normal' }
                            },
                            vitals: { bp: '130/85', heartRate: '70 bpm', temperature: '37.1°C' },
                            treatment: 'Surgical Resection + Chemoradiation',
                            treatmentPlan: {
                                medications: [
                                    { name: 'Dexamethasone', dosage: '4mg PO QID', purpose: 'To reduce cerebral edema' },
                                    { name: 'Levetiracetam', dosage: '500mg PO BID', purpose: 'Seizure prophylaxis' }
                                ],
                                consultations: [ { specialty: 'Neurosurgery', date: 'Oct 19, 2025', status: 'Completed' }, { specialty: 'Neuro-Oncology', date: 'Oct 22, 2025', status: 'Scheduled' } ],
                                monitoring: ['Weekly CBC during chemotherapy', 'MRI brain every 2 months post-treatment']
                            }
                        }
                    },
                };
                const patient = localDB[patientId] || mockPatientData[patientId] || Object.values(localDB)[0] || mockPatientData['P-2025-001']; // Enhanced Fallback
                return Promise.resolve(patient);
            }

            /**
             * Checks if a lab value is outside its normal range.
             * @param {number} value The lab value to check.
             * @param {string} rangeStr The normal range as a string (e.g., "< 10", "3.5-5.0").
             * @returns {boolean} True if the value is abnormal.
             */
            function isAbnormal(value, rangeStr) {
                if (!rangeStr || rangeStr.toLowerCase() === 'n/a') return false;

                if (rangeStr.includes('-')) {
                    const [min, max] = rangeStr.split('-').map(parseFloat);
                    return value < min || value > max;
                } else if (rangeStr.startsWith('<')) {
                    const max = parseFloat(rangeStr.substring(1));
                    return value >= max;
                } else if (rangeStr.startsWith('>')) {
                    const min = parseFloat(rangeStr.substring(1));
                    return value <= min;
                }
                return false;
            }

            /**
             * Updates the UI with patient information.
             * @param {object} patient The patient data object.
             */
            function updatePatientInfo(patient) {
                const printHeader = document.querySelector('.print-header');
                if (!patient) return;

                const elements = {
                    patientName: patient.name,
                    patientInitials: patient.initials,
                    patientId: `ID: ${patient.id}`, // This is not editable
                    patientAge: `${patient.age} years`,
                    patientGender: patient.gender,
                    patientBloodType: patient.bloodType,
                    patientHeight: patient.height,
                    patientWeight: patient.weight,
                    bp: patient.diagnosis?.vitals?.bp,
                    heartRate: patient.diagnosis?.vitals?.heartRate,
                    temperature: patient.diagnosis?.vitals?.temperature,
                    diagnosisCondition: patient.diagnosis?.condition,
                    diagnosisDetails: patient.diagnosis?.details,
                    diagnosisDate: patient.diagnosis?.date,
                    currentTreatment: patient.diagnosis?.treatment,
                };

                for (const [id, value] of Object.entries(elements)) {
                    const element = document.getElementById(id);
                    if (element && value !== undefined) {
                        element.textContent = value;
                    }
                }

                // Populate the simplified print header
                if (printHeader) {
                    printHeader.innerHTML = `
                        <h2 class="text-2xl font-bold">${patient.name}</h2>
                        <p class="text-gray-600">ID: ${patient.id} | Age: ${patient.age} | Gender: ${patient.gender}</p>
                        <p class="mt-2"><strong>Primary Diagnosis:</strong> ${patient.diagnosis.condition}</p>
                    `;
                }
                // Update AI Prognosis with color
                const prognosisEl = document.getElementById('aiPrognosis');
                if (prognosisEl && patient.diagnosis?.aiPrognosis) {
                    prognosisEl.textContent = patient.diagnosis.aiPrognosis.risk.toUpperCase();
                    // Reset classes and apply new color
                    prognosisEl.className = 'font-bold text-lg'; // Base classes
                    const colorClass = `text-${patient.diagnosis.aiPrognosis.color}-600`;
                    prognosisEl.classList.add(colorClass);
                }

                // Update structured AI insights
                const findingsEl = document.getElementById('aiKeyFindings');
                if (findingsEl && patient.diagnosis?.aiKeyFindings) { // Changed from list to paragraph
                    findingsEl.innerHTML = linkifyMedicalTerms(patient.diagnosis.aiKeyFindings);
                }
                const differentialEl = document.getElementById('aiDifferential');
                if (differentialEl && patient.diagnosis?.aiDifferential) {
                    differentialEl.textContent = patient.diagnosis.aiDifferential;
                }

                const nextStepsEl = document.getElementById('aiNextSteps');
                if (nextStepsEl && patient.diagnosis?.aiNextSteps) {
                    nextStepsEl.innerHTML = linkifyMedicalTerms(patient.diagnosis.aiNextSteps);
                }
            }

            /**
             * Updates the main analysis status badge.
             * @param {string} status The status ('processing', 'complete', etc.).
             */
            function updateAnalysisStatus(status) {
                const statusBadge = document.getElementById('analysisStatus');
                if (!statusBadge) return;

                statusBadge.classList.remove('status-ready', 'status-processing');
                const indicator = statusBadge.querySelector('span');

                if (status === 'complete') {
                    statusBadge.classList.add('status-ready');
                    indicator.className = 'w-2 h-2 bg-green-500 rounded-full';
                    statusBadge.innerHTML = `${indicator.outerHTML} Analysis Complete`;
                } else {
                    statusBadge.classList.add('status-processing');
                    indicator.className = 'processing-indicator';
                    statusBadge.innerHTML = `${indicator.outerHTML} Analysis In Progress`;
                }
            }


            /**
             * Simulates the analysis workflow progress.
             */
            function setupWorkflowHandlers(initialStatus) {
                const steps = ['nlp', 'fusion', 'analysis'];
                let currentStep = 0;

                function updateWorkflowStep() {
                    // Deactivate previous step
                    if (currentStep > 0) {
                        const prevStepElement = document.querySelector(`[data-step="${steps[currentStep - 1]}"]`);
                        if (prevStepElement) prevStepElement.classList.remove('active');
                    }

                    if (currentStep >= steps.length) {
                        updateAnalysisStatus('complete');
                        return;
                    }

                    const step = steps[currentStep];
                    const stepElement = document.querySelector(`[data-step="${step}"]`);
                    
                    if (stepElement) {
                        stepElement.classList.add('active');
                        const indicator = stepElement.querySelector('.processing-indicator');
                        indicator.classList.add('status-processing');

                        setTimeout(() => {
                            stepElement.classList.add('completed');
                            indicator.classList.remove('status-processing');
                            indicator.classList.add('status-completed');
                            currentStep++;
                            updateWorkflowStep();
                        }, 1200);
                    }
                }
                setTimeout(updateWorkflowStep, 500);
            }

            /**
             * Populates the lab results table.
             * @param {object} results The lab results data.
             */
            function updateLabResults(results) {
                const tableBody = document.querySelector('#labResultsTable tbody');
                if (!tableBody || !results) return;
                const rows = Object.entries(results).map(([test, data]) => {
                    const statusColor = data.status.toLowerCase() === 'normal' ? 'green' : (data.status.toLowerCase() === 'high' ? 'red' : 'blue');
                    const isAbnormal = data.status.toLowerCase() !== 'normal';
                    
                    let trendCell = '<td class="px-4 py-2 sparkline-cell">--</td>';
                    if (isAbnormal && data.history && data.history.length > 1) {
                        trendCell = `<td class="px-4 py-2 sparkline-cell">${generateSparkline(data.history, statusColor)}</td>`;
                    }

                    return `
                        <tr data-test-name="${test}" class="cursor-pointer">
                            <td class="px-4 py-2">${test}</td>
                            <td class="px-4 py-2 text-right font-semibold">${data.value}</td>
                            ${trendCell}
                            <td class="px-4 py-2">${data.range}</td>
                            <td class="px-4 py-2">
                                <span class="font-bold text-${statusColor}-600">${data.status}</span>
                            </td>
                        </tr>
                    `;
                });
                tableBody.innerHTML = rows.join('');
            }

            /**
             * Updates the organ diagram to highlight the affected organ.
             * @param {string} affectedOrganId The ID of the organ to highlight.
             */
            function updateOrganDiagram(affectedOrganId) {
                const diagram = document.getElementById('organ-diagram');
                if (!diagram) return;

                // Reset all organ paths
                diagram.querySelectorAll('.organ-path').forEach(path => {
                    path.classList.remove('affected');
                });

                if (!affectedOrganId) return;

                // Handle compound IDs like 'lungs' or 'kidneys'
                if (affectedOrganId === 'lungs') {
                    document.getElementById('organ-lung-left')?.classList.add('affected');
                    document.getElementById('organ-lung-right')?.classList.add('affected');
                } else if (affectedOrganId === 'kidneys') {
                    document.getElementById('organ-kidney-left')?.classList.add('affected');
                    document.getElementById('organ-kidney-right')?.classList.add('affected');
                } else if (affectedOrganId === 'brain') {
                    document.getElementById('organ-brain')?.classList.add('affected');
                } else if (affectedOrganId === 'thyroid') {
                    document.getElementById('organ-thyroid')?.classList.add('affected');
                } else if (affectedOrganId === 'spleen') {
                    document.getElementById('organ-spleen')?.classList.add('affected');
                } else {
                    // Handle single organ ID
                    const organElement = document.getElementById(`organ-${affectedOrganId}`);
                    if (organElement) organElement.classList.add('affected');
                }
            }

            /**
             * Sets up the event listeners for the organ diagram tooltips.
             * @param {object} patient The patient data object.
             */
            function setupOrganTooltips(patient) {
                const diagram = document.getElementById('organ-diagram');
                const infoBox = document.getElementById('organ-info-box');

                if (!diagram || !infoBox) return;
                const organNameMap = {
                    'brain': 'Brain', 'thyroid': 'Thyroid', 'lung-left': 'Left Lung', 'lung-right': 'Right Lung',
                    'heart': 'Heart', 'liver': 'Liver', 'stomach': 'Stomach', 'spleen': 'Spleen',
                    'pancreas': 'Pancreas', 'kidney-left': 'Left Kidney', 'kidney-right': 'Right Kidney',
                    'intestines': 'Intestines', 'breast-left': 'Left Breast', 'breast-right': 'Right Breast'
                };

                diagram.querySelectorAll('.organ-path').forEach(path => {
                    path.addEventListener('mousemove', (e) => {
                        const organId = path.id.replace('organ-', '');
                        const organName = organNameMap[organId] || 'Unknown Organ';
                        let condition = 'Normal';

                        // Check if this organ is affected
                        const affectedId = patient.diagnosis.affectedOrgan;
                        const isAffected = (affectedId === organId) ||
                                           (affectedId === 'lungs' && organId.includes('lung')) ||
                                           (affectedId === 'kidneys' && organId.includes('kidney'));

                        if (isAffected) {
                            condition = patient.diagnosis.condition;
                        }

                        infoBox.innerHTML = `<strong class="block text-lg text-primary-700">${organName}</strong><span class="text-gray-600">${condition}</span>`;
                        infoBox.classList.add('shadow-md');
                    });

                    path.addEventListener('mouseleave', () => {
                        infoBox.innerHTML = `<span class="text-gray-500 italic">Hover over an organ to see details</span>`;
                        infoBox.classList.remove('shadow-md');
                    });
                });
            }


            /**
             * Populates the redesigned treatment plan tab.
             * @param {object} planData The treatment plan data object.
             */
            function updateTreatmentPlan(planData) {
                const medsList = document.getElementById('medications-list');
                const consultsList = document.getElementById('consultations-list');
                const monitoringList = document.getElementById('monitoring-list');

                if (!planData || !medsList || !consultsList || !monitoringList) {
                    // Fallback for missing data
                    medsList.innerHTML = '<p class="text-gray-500">No medication data available.</p>';
                    return;
                }

                // Populate Medications
                medsList.innerHTML = planData.medications.map(med => `
                    <div class="medication-item">
                        <div>
                            <div class="medication-name">${med.name}</div>
                            <div class="medication-purpose">${med.purpose}</div>
                        </div>
                        <div class="text-right text-gray-800 font-medium">${med.dosage}</div>
                    </div>
                `).join('');

                // Populate Consultations
                consultsList.innerHTML = planData.consultations.map(consult => `
                    <div class="consult-item">
                        <div>
                            <div class="consult-specialty">${consult.specialty}</div>
                            <div class="text-sm text-gray-500">${consult.date}</div>
                        </div>
                        <div class="consult-status ${consult.status.toLowerCase()}">${consult.status}</div>
                    </div>
                `).join('');

                // Populate Monitoring
                monitoringList.innerHTML = planData.monitoring.map(item => `
                    <li>${item}</li>
                `).join('');
            }

            /**
             * Populates the clinical timeline tab.
             * @param {object} patient The patient data object.
             */
            function updateTimeline(patient) {
                const timelineContainer = document.getElementById('clinical-timeline');
                if (!timelineContainer || !patient.diagnosis) return;

                let events = [];

                // 1. Diagnosis Event
                if (patient.diagnosis.date) {
                    events.push({
                        date: new Date(patient.diagnosis.date),
                        type: 'Diagnosis',
                        title: `Primary Diagnosis: ${patient.diagnosis.condition}`,
                        details: patient.diagnosis.details || 'Initial assessment.'
                    });
                }

                // 2. Consultation Events
                patient.diagnosis.treatmentPlan?.consultations.forEach(consult => {
                    events.push({
                        date: new Date(consult.date),
                        type: 'Consultation',
                        title: `Consultation: ${consult.specialty}`,
                        details: `Status: ${consult.status}`
                    });
                });

                // Sort events chronologically
                events.sort((a, b) => b.date - a.date);

                // 3. Generate HTML
                timelineContainer.innerHTML = events.map(event => {
                    const icon = event.type === 'Diagnosis' ? '⚕️' : '👥';
                    return `
                        <li class="timeline-item">
                            <div class="timeline-icon">${icon}</div>
                            <p class="timeline-date">${event.date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                            <div class="timeline-content">
                                <h4 class="font-semibold">${event.title}</h4>
                                <p class="text-sm text-gray-600">${event.details}</p>
                            </div>
                        </li>
                    `;
                }).join('');

                if (events.length === 0) {
                    timelineContainer.innerHTML = `
                        <li class="timeline-item">
                            <p class="text-gray-500 italic">No clinical timeline events found.</p>
                        </li>`;
                }
            }


            /**
             * Sets up the event listeners for the organ detail modal.
             * @param {object} patient The patient data object.
             */
            function setupOrganModal(patient) {
                const diagram = document.getElementById('organ-diagram');
                if (!diagram || !patient.diagnosis) return;

                diagram.addEventListener('click', (e) => {
                    if (e.target.classList.contains('affected')) {
                        // Find and click the "AI Insights" tab button
                        const aiTabButton = document.querySelector('.tab-button[data-tab="ai"]');
                        if (aiTabButton) {
                            aiTabButton.click();

                            // Scroll the AI tab content into view
                            const aiTabContent = document.getElementById('tab-ai');
                            if (aiTabContent) {
                                aiTabContent.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }
                        }
                    }
                });
            }

            /**
             * Sets up the modal for displaying historical lab data charts.
             * @param {object} patient The patient data object.
             */
            function setupLabChartModal(patient) {
                const tableBody = document.querySelector('#labResultsTable tbody');
                const modal = document.getElementById('lab-chart-modal');
                const modalTitle = document.getElementById('lab-chart-title');
                const canvas = document.getElementById('lab-chart-canvas');
                const closeButtons = [
                    document.getElementById('lab-chart-close-btn'),
                    document.getElementById('lab-chart-close-btn-x')
                ];
                let chartInstance = null;

                if (!tableBody || !modal || !canvas) return;

                tableBody.addEventListener('click', (e) => {
                    const row = e.target.closest('tr');
                    if (!row) return;

                    const testName = row.dataset.testName;
                    const labData = patient.diagnosis.labResults[testName];

                    if (labData && labData.history && labData.history.length > 1) {
                        modalTitle.textContent = `${testName} Trend`;

                        if (chartInstance) {
                            chartInstance.destroy();
                        }

                        chartInstance = new Chart(canvas, {
                            type: 'line',
                            data: {
                                labels: labData.history.map((_, i) => `Point ${i + 1}`),
                                datasets: [{
                                    label: testName,
                                    data: labData.history,
                                    borderColor: 'var(--primary-500)',
                                    backgroundColor: 'rgba(14, 165, 233, 0.1)',
                                    fill: true,
                                    tension: 0.3,
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: true,
                                scales: { y: { beginAtZero: false } }
                            }
                        });

                        modal.classList.add('visible');
                    }
                });

                const closeModal = () => modal.classList.remove('visible');
                closeButtons.forEach(btn => btn.addEventListener('click', closeModal));
                modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
            }

            /**
             * Sets up the event listeners for the image viewer modal.
             */
            function setupImageViewer() {
                const imagingGrid = document.getElementById('imaging-grid');
                const modal = document.getElementById('image-viewer-modal');
                const modalImage = document.getElementById('modal-image-content');
                const modalCaption = document.getElementById('modal-image-caption');
                const closeModalBtn = document.getElementById('image-modal-close-btn');
                let scale = 1, panning = false,
                    pointX = 0, pointY = 0,
                    start = { x: 0, y: 0 };


                if (!imagingGrid || !modal) return;

                imagingGrid.addEventListener('click', (e) => {
                    const imageCard = e.target.closest('.image-card');
                    if (!imageCard) return;

                    const img = imageCard.querySelector('img');
                    const caption = imageCard.querySelector('.text-sm');

                    if (img && caption) {
                        modalImage.src = img.src;
                        modalImage.alt = img.alt;
                        modalCaption.textContent = caption.textContent;
                        resetZoom();
                        modal.classList.add('visible');
                    }
                });

                function setTransform() {
                    modalImage.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`;
                }

                function resetZoom() {
                    scale = 1;
                    pointX = 0;
                    pointY = 0;
                    setTransform();
                }

                modalImage.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    start = { x: e.clientX - pointX, y: e.clientY - pointY };
                    panning = true;
                    modalImage.style.cursor = 'grabbing';
                });

                modalImage.addEventListener('mouseup', () => {
                    panning = false;
                    modalImage.style.cursor = 'grab';
                });

                modalImage.addEventListener('mouseleave', () => {
                    panning = false;
                    modalImage.style.cursor = 'grab';
                });

                modalImage.addEventListener('mousemove', (e) => {
                    e.preventDefault();
                    if (!panning) return;
                    pointX = (e.clientX - start.x);
                    pointY = (e.clientY - start.y);
                    setTransform();
                });

                modalImage.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    const delta = e.deltaY < 0 ? 0.1 : -0.1;
                    scale = Math.min(Math.max(0.5, scale + delta), 4); // Clamp scale between 0.5x and 4x
                    setTransform();
                });

                const closeModal = () => modal.classList.remove('visible');
                closeModalBtn.addEventListener('click', closeModal);
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeModal(); // Click on backdrop
                });
                window.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && modal.classList.contains('visible')) closeModal();
                });
            }


            /**
             * Generates an SVG sparkline chart.
             * @param {number[]} data - Array of numerical data points.
             * @param {string} color - The color of the line (e.g., 'red', 'green').
             * @returns {string} - The SVG element as a string.
             */
            function generateSparkline(data, color) {
                const width = 100;
                const height = 30;
                const strokeColor = `var(--${color}-500, var(--text-secondary))`;

                const min = Math.min(...data);
                const max = Math.max(...data);
                const range = max - min;

                const points = data.map((d, i) => {
                    const x = (i / (data.length - 1)) * width;
                    const y = height - ((d - min) / (range || 1)) * height;
                    return `${x},${y}`;
                }).join(' ');

                return `
                    <svg viewBox="0 0 ${width} ${height}" width="${width}" height="${height}" preserveAspectRatio="none">
                        <polyline points="${points}" fill="none" stroke="${strokeColor}" />
                    </svg>
                `;
            }

            /**
             * Shows a toast notification.
             * @param {string} message The message to display.
             * @param {string} type The type of toast ('success', 'error').
             */
            function showToast(message, type = 'success') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = 'toast';
                toast.innerHTML = `<span>${type === 'success' ? '✅' : '❌'}</span> ${message}`;
                container.appendChild(toast);

                setTimeout(() => toast.classList.add('show'), 10); // Animate in
                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, 3000); // Animate out and remove
            }

            /**
             * Finds medical terms in a text and wraps them in clickable links.
             * @param {string} text The text to process.
             * @returns {string} The text with HTML links for glossary terms.
             */
            function linkifyMedicalTerms(text) {
                if (!text) return '';
                const terms = Object.keys(medicalGlossary).join('|');
                const regex = new RegExp(`\\b(${terms})\\b`, 'gi');
                return text.replace(regex, (match) => {
                    return `<a href="#" class="medical-term-link" data-term="${match.toLowerCase()}">${match}</a>`;
                });
            }

            /**
             * Sets up event listeners for the definition modal.
             */
            function setupDefinitionModal() {
                const modal = document.getElementById('definition-modal');
                const modalTerm = document.getElementById('modal-term');
                const modalDefinition = document.getElementById('modal-definition');
                const closeModalBtn = document.getElementById('modal-close-btn');

                document.body.addEventListener('click', (e) => {
                    if (e.target.classList.contains('medical-term-link')) {
                        e.preventDefault();
                        const term = e.target.dataset.term;
                        const definition = medicalGlossary[term];
                        if (definition) {
                            modalTerm.textContent = e.target.textContent;
                            modalDefinition.textContent = definition;
                            modal.classList.add('visible');
                        }
                    }
                });

                const closeModal = () => modal.classList.remove('visible');
                closeModalBtn.addEventListener('click', closeModal);
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeModal(); // Click on backdrop
                });
                window.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && modal.classList.contains('visible')) closeModal();
                });
            }

            /**
             * Sets up the tab switching functionality.
             */
            function setupTabs() {
                const tabButtons = document.querySelectorAll('.tab-button');
                const tabContents = document.querySelectorAll('.tab-content');

                tabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        // Deactivate all
                        tabButtons.forEach(btn => btn.classList.remove('active'));
                        tabContents.forEach(content => content.classList.remove('active'));

                        // Activate clicked
                        button.classList.add('active');
                        const tabId = button.dataset.tab;
                        document.getElementById(`tab-${tabId}`).classList.add('active');
                    });
                });
            }

            /**
             * Sets up the edit tab with a form for clinical data.
             * @param {object} patient The current patient data object.
             */
            function setupEditTab(patient) {
                const editableVitalsContainer = document.getElementById('editable-vitals');
                const editableLabsContainer = document.getElementById('editable-labs');
                const editableTreatmentTextarea = document.getElementById('editable-treatment');
                const editForm = document.getElementById('edit-form');
                const resetBtn = document.getElementById('reset-edit-form');
                
                let originalClinicalData = {};

                if (!editableVitalsContainer || !editableLabsContainer || !editableTreatmentTextarea || !editForm) return;

                // Populate editable vitals
                let vitalsHtml = '';
                const vitals = patient.diagnosis.vitals || {};
                const vitalFields = { bp: 'Blood Pressure', heartRate: 'Heart Rate', temperature: 'Temperature' };

                function populateEditForm() {
                    // Store a deep copy of the original data for comparison and reset
                    originalClinicalData = JSON.parse(JSON.stringify(patient.diagnosis));

                    // Populate editable vitals
                    let vitalsHtml = '';
                    for (const key in vitalFields) {
                        const label = vitalFields[key];
                        vitalsHtml += `
                            <div class="grid grid-cols-3 gap-4 items-center">
                                <label for="edit-vital-${key}" class="col-span-1 font-medium text-sm">${label}</label>
                                <input type="text" id="edit-vital-${key}" name="${key}" value="${vitals[key] || ''}" class="col-span-2" />
                            </div>
                        `;
                    }
                    editableVitalsContainer.innerHTML = vitalsHtml;
                    
                    // Populate editable labs
                    let labsHtml = '';
                    for (const test in patient.diagnosis.labResults) {
                        const result = patient.diagnosis.labResults[test];
                        labsHtml += `
                            <div class="grid grid-cols-3 gap-4 items-center">
                                <label for="edit-lab-${test}" class="col-span-1 font-medium text-sm">${test}</label>
                                <input type="text" id="edit-lab-${test}" name="${test}" value="${result.value}" class="col-span-2" />
                            </div>
                        `;
                    }
                    editableLabsContainer.innerHTML = labsHtml;

                    // Populate editable treatment plan
                    editableTreatmentTextarea.value = patient.diagnosis.treatment;
                }

                populateEditForm(); // Initial population

                resetBtn.addEventListener('click', () => {
                    populateEditForm(); // Re-populate with original patient data
                    showToast('Form has been reset to original values.', 'info');
                });

                // Handle form submission
                editForm.addEventListener('submit', (e) => {
                    e.preventDefault();

                    const changes = [];

                    // --- 1. Gather and Compare Changes ---

                    // Compare Vitals
                    for (const key in vitalFields) {
                        const input = document.getElementById(`edit-vital-${key}`);
                        const newValue = input.value;
                        const oldValue = originalClinicalData.vitals[key] || '';
                        if (newValue !== oldValue) {
                            changes.push({ field: vitalFields[key], from: oldValue, to: newValue });
                        }
                    }

                    // Compare Labs
                    for (const test in originalClinicalData.labResults) {
                        const input = document.getElementById(`edit-lab-${test}`);
                        const newValue = input.value;
                        const oldValue = originalClinicalData.labResults[test].value;
                        if (newValue !== oldValue) {
                            changes.push({ field: test, from: oldValue, to: newValue });
                        }
                    }

                    // Compare Treatment Plan
                    const newTreatment = editableTreatmentTextarea.value;
                    const oldTreatment = originalClinicalData.treatment;
                    if (newTreatment !== oldTreatment) {
                        changes.push({ field: 'Treatment Plan', from: oldTreatment, to: newTreatment });
                    }

                    // --- 2. Show Confirmation Modal or "No Changes" Toast ---

                    if (changes.length === 0) {
                        showToast('No changes to save.', 'info');
                        return;
                    }

                    const summaryContainer = document.getElementById('changes-summary');
                    summaryContainer.innerHTML = changes.map(change => 
                        `<div>
                            <strong>${change.field}:</strong>
                            <div class="pl-4">
                                <span class="text-red-600 line-through">${change.from}</span> → 
                                <span class="text-green-600">${change.to}</span>
                            </div>
                        </div>`
                    ).join('');

                    const confirmModal = document.getElementById('confirm-save-modal');
                    confirmModal.classList.add('visible');
                });

                // --- 3. Handle Actual Save from Confirmation Modal ---
                document.getElementById('confirm-save-btn').addEventListener('click', () => {
                    let isValid = true;
                    // Validate lab inputs
                    for (const test in patient.diagnosis.labResults) {
                        const input = document.getElementById(`edit-lab-${test}`);
                        if (input) {
                            if (isNaN(parseFloat(input.value))) {
                                isValid = false;
                                input.style.borderColor = 'var(--danger)'; // Highlight invalid field
                            } else {
                                input.style.borderColor = 'var(--border)'; // Reset border color
                            }
                        }
                    }

                    for (const key in vitalFields) {
                        const input = document.getElementById(`edit-vital-${key}`);
                        if (input) {
                            patient.diagnosis.vitals[key] = input.value;
                        }
                    }

                    if (!isValid) {
                        document.getElementById('confirm-save-modal').classList.remove('visible');
                        showToast('Please enter a valid number for all lab results.', 'error');
                        return;
                    }

                    // Update lab results in the patient object
                    for (const test in patient.diagnosis.labResults) {
                        const input = document.getElementById(`edit-lab-${test}`);
                        if (input) {
                            patient.diagnosis.labResults[test].value = input.value;
                        }
                    }

                    // Update treatment plan
                    patient.diagnosis.treatment = editableTreatmentTextarea.value;

                    // Re-render the display tabs to show the new data
                    updatePatientInfo(patient); // This will update the vitals display
                    updateLabResults(patient.diagnosis.labResults);

                    // Provide user feedback
                    showToast('Patient records updated successfully!', 'success');

                    // Close the modal
                    document.getElementById('confirm-save-modal').classList.remove('visible');

                    // Optional: Switch back to the overview tab
                    const overviewTabButton = document.querySelector('.tab-button[data-tab="overview"]');
                    if (overviewTabButton) {
                        overviewTabButton.click();
                    }
                });

                document.getElementById('cancel-save-btn').addEventListener('click', () => {
                    document.getElementById('confirm-save-modal').classList.remove('visible');
                });
            }

            /**
             * Makes a table's headers clickable for sorting.
             * @param {HTMLTableElement} table The table to make sortable.
             */
            function makeTableSortable(table) {
                if (!table) return;
                const headers = table.querySelectorAll('th');
                headers.forEach((header, index) => {
                    header.addEventListener('click', () => {
                        sortTableByColumn(table, index);
                    });
                });
            }

            /**
             * Sorts a table by a specific column.
             * @param {HTMLTableElement} table The table to sort.
             * @param {number} columnIndex The index of the column to sort by.
             */
            function sortTableByColumn(table, columnIndex) {
                const tBody = table.tBodies[0];
                const rows = Array.from(tBody.querySelectorAll('tr'));
                const header = table.querySelectorAll('th')[columnIndex];
                const sortDirection = header.dataset.sortDir === 'desc' ? 'asc' : 'desc';

                // Reset sort indicators
                table.querySelectorAll('th').forEach(th => {
                    th.dataset.sortDir = '';
                    th.querySelector('.sort-indicator').textContent = '';
                });

                header.dataset.sortDir = sortDirection;
                header.querySelector('.sort-indicator').textContent = sortDirection === 'asc' ? ' ▲' : ' ▼';

                const isNumericColumn = header.textContent.includes('Result');

                rows.sort((a, b) => {
                    let valA = a.cells[columnIndex].textContent.trim();
                    let valB = b.cells[columnIndex].textContent.trim();

                    if (isNumericColumn) {
                        valA = parseFloat(valA) || 0;
                        valB = parseFloat(valB) || 0;
                    }

                    if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                    if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                    return 0;
                });

                // Re-append sorted rows
                tBody.innerHTML = '';
                rows.forEach(row => tBody.appendChild(row));
            }

            // Initialize the dashboard when the DOM is ready
            document.addEventListener('DOMContentLoaded', main);

        })();
    </script>
</body>
</html>
