<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MDDA: Enroll New Patient</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-50: #eff6ff;
            --primary-100: #dbeafe; 
            --primary-400: #60a5fa;
            --primary-500: #3b82f6;
            --primary-600: #2563eb;
            --bg-main: #f8fafc;
            --success-100: #dcfce7;
            --success-500: #22c55e;
            --purple-100: #f3e8ff;
            --purple-600: #9333ea;
            --surface: #ffffff;
            --border: #e2e8f0;
            --text-primary: #1e293b; /* slate-800 */
            --text-secondary: #64748b; /* slate-500 */
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 2rem;
            background-color: var(--bg-main);
            background: linear-gradient(-45deg, #f5f3ff, #e0f2fe, #dcfce7, #f0f9ff);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            box-sizing: border-box;
        }
        
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes pulseGlow {
            50% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.4); }
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2.5rem;
            background-color: var(--surface);
            border-radius: 0.75rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            animation: fadeInUp 0.6s ease-out forwards;
            opacity: 0;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header {
            padding-bottom: 1rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .header h1 {
            font-size: 2.25rem;
            font-weight: 800;
            margin-bottom: 5px;
            background: linear-gradient(135deg, var(--primary-600), #be185d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Stepper/Wizard Styles */
        .stepper-wrapper {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2.5rem;
        }
        .step {
            text-align: center;
            flex-grow: 1;
            position: relative;
        }
        .step-number {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: #e2e8f0; /* slate-200 */
            color: var(--text-secondary);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        .step-title {
            margin-top: 0.5rem;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }
        .step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 18px;
            left: 50%;
            height: 2px;
            width: 100%;
            background-color: #e2e8f0;
            z-index: -1;
            transition: all 0.3s ease;
        }
        .step.active .step-number {
            background-color: var(--primary-100);
            border-color: var(--primary-500);
            color: var(--primary-600);
            animation: pulseGlow 2s infinite ease-in-out;
            transform: scale(1.1);
        }
        .step.active .step-title {
            color: var(--primary-600);
        }
        .step[data-step="2"].active .step-number { background-color: var(--success-100); border-color: var(--success-500); color: #16a34a; }
        .step[data-step="2"].active .step-title { color: #16a34a; }
        .step[data-step="3"].active .step-number { background-color: var(--purple-100); border-color: var(--purple-600); color: #7e22ce; }
        .step[data-step="3"].active .step-title { color: #7e22ce; }

        .step.completed .step-number {
            background-color: var(--primary-500);
            border-color: var(--primary-500);
            color: white;
            animation: none;
        }
        .step.completed .step-title {
            color: var(--text-primary);
        }
        .step[data-step="1"].completed:not(:last-child)::after {
            background-color: var(--primary-500);
        }
        .step[data-step="2"].completed .step-number {
            background-color: var(--success-500); border-color: var(--success-500);
        }
        .step[data-step="2"].completed:not(:last-child)::after {
            background-color: var(--success-500);
        }

        .step.completed:not(:last-child)::after {
            background: linear-gradient(to right, var(--primary-500), var(--success-500));
        }

        /* Form Step Styling */
        .form-step {
            display: none;
            animation: fadeIn 0.5s;
        }
        .form-step.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .form-step h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.75rem;
        }

        .form-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
        }
        .input-group { 
            flex-basis: calc(50% - 10px); 
            box-sizing: border-box;
            position: relative;
        }
        .input-group-third { flex-basis: calc(33.333% - 13.333px); box-sizing: border-box; }
        .input-group-full { flex-basis: 100%; }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.9em;
        }

        input[type="text"], 
        input[type="date"],
        input[type="number"], 
        select, 
        textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            background-color: var(--bg-main);
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            box-sizing: border-box;
            font-size: 1em;
            color: var(--text-primary);
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .input-group .icon-input {
            padding-left: 2.5rem;
        }

        input:focus, select:focus, textarea:focus, input[type="file"]:focus {
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px var(--primary-100), inset 0 1px 2px rgba(0,0,0,0.05);
            outline: none;
            background-color: var(--surface);
        }

        input[type="file"] {
            border: 2px dashed var(--border);
            padding: 15px;
            background-color: var(--bg-main);
            cursor: pointer;
            color: var(--text-secondary);
        }
        
        select {
            appearance: none; 
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.5em 1.5em;
            padding-right: 30px;
        }

        textarea { resize: vertical; min-height: 100px; }

        .form-navigation {
            margin-top: 2rem;
            display: flex;
            justify-content: space-between;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.375rem;
            font-size: 1em;
            font-weight: 700;
            cursor: pointer;
            display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
            color: white;
            box-shadow: 0 4px 14px rgba(59, 130, 246, 0.25);
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-400), var(--primary-500));
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background-color: #e2e8f0; /* slate-200 */
            color: var(--text-primary);
        }
        .btn-secondary:hover {
            background-color: #cbd5e1; /* slate-300 */
        }
        
        .input-icon {
            position: absolute;
            left: 0.75rem;
            top: calc(50% + 8px);
            transform: translateY(-50%);
            color: var(--text-secondary);
            opacity: 0.6;
            pointer-events: none;
        }

        @media (max-width: 768px) {
            body { padding: 1rem; }
            .container { padding: 1.5rem; }
            .input-group, .input-group-third {
                flex-basis: 100%;
            }
            .stepper-wrapper {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            .step:not(:last-child)::after { display: none; }
        }

    </style>
</head>
<body onload="loadFormData()">
    <div class="container">
        <div class="header">
            <h1>Patient Enrollment</h1>
            <p>Create a new multi-modal diagnostic profile.</p>
        </div>

        <!-- Stepper -->
        <div class="stepper-wrapper">
            <div class="step active" data-step="1">
                <div class="step-number">1</div>
                <div class="step-title">Demographics</div>
            </div>
            <div class="step" data-step="2">
                <div class="step-number">2</div>
                <div class="step-title">Clinical Info</div>
            </div>
            <div class="step" data-step="3">
                <div class="step-number">3</div>
                <div class="step-title">Uploads</div>
            </div>
        </div>

        <form id="patientForm" oninput="saveFormData()">
            <!-- Step 1: Demographics -->
            <div class="form-step active" data-step="1">
                <h2>Core Identifiers & Demographics</h2>
                <div class="form-grid">
                    <div class="form-grid">
                        
                        <div class="input-group">
                            <span class="input-icon">🆔</span>
                            <label for="p_id">Internal Patient ID (Required)</label>
                            <input type="text" id="p_id" name="patient_id" required placeholder="P-2025-0001" class="icon-input">
                        </div>
                        
                        <div class="input-group">
                            <span class="input-icon">🎂</span>
                            <label for="dob">Date of Birth</label>
                            <input type="date" id="dob" name="dob" required class="icon-input">
                        </div>
                        
                        <div class="input-group">
                            <label for="first_name">First Name</label>
                            <input type="text" id="first_name" name="first_name" required>
                        </div>
                        
                        <div class="input-group">
                            <label for="last_name">Last Name</label>
                            <input type="text" id="last_name" name="last_name" required>
                        </div>

                        <div class="input-group">
                            <label for="gender">Biological Sex</label>
                            <select id="gender" name="gender">
                                <option value="" disabled selected>Select</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other/Unspecified</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label for="ethnicity">Ethnicity / Ancestry</label>
                            <input type="text" id="ethnicity" name="ethnicity" placeholder="For genetic context">
                        </div>
                    </div>
                </div>
                <div class="form-navigation">
                    <button type="button" class="btn btn-primary btn-next">Next &rarr;</button>
                </div>
            </div>

            <!-- Step 2: Clinical Info -->
            <div class="form-step" data-step="2">
                <h2>Initial Clinical Assessment</h2>
                <div class="form-grid">
                        
                        <div class="input-group">
                            <label for="diagnosis_date">Date of Primary Diagnosis</label>
                            <input type="date" id="diagnosis_date" name="diagnosis_date">
                        </div>

                        <div class="input-group">
                            <label for="primary_site">Primary Tumor Site / Affected Organ</label>
                            <input type="text" id="primary_site" name="primary_site" placeholder="e.g., Left Cerebral Hemisphere">
                        </div>
                        
                        <div class="input-group">
                            <label for="diagnosis_type">Preliminary Diagnosis Code (ICD/SNOMED)</label>
                            <input type="text" id="diagnosis_type" name="diagnosis_type" placeholder="e.g., C34.9, ICD-O: 8000/3">
                        </div>

                        <div class="input-group">
                            <label for="enroll_clinician">Enrolling Clinician ID</label>
                            <input type="text" id="enroll_clinician" name="enroll_clinician" required placeholder="Your Practitioner ID">
                        </div>
                        
                        <div class="input-group-full">
                            <label>TNM Staging (For Cancer Cases)</label>
                            <p style="margin-top: -5px; margin-bottom: 10px; color: var(--text-secondary); font-size: 0.8em;">Enter specific values (e.g., T1, N0, M1)</p>
                            <div class="form-grid">
                                <div class="input-group-third">
                                    <label for="t_stage">T (Tumor Size)</label>
                                    <input type="text" id="t_stage" name="t_stage" placeholder="e.g., T2">
                                </div>
                                <div class="input-group-third">
                                    <label for="n_stage">N (Nodes Involvement)</label>
                                    <input type="text" id="n_stage" name="n_stage" placeholder="e.g., N1">
                                </div>
                                <div class="input-group-third">
                                    <label for="m_stage">M (Metastasis)</label>
                                    <input type="text" id="m_stage" name="m_stage" placeholder="e.g., M0">
                                </div>
                            </div>
                        </div>
                </div>
                <div class="form-navigation">
                    <button type="button" class="btn btn-secondary btn-prev">&larr; Previous</button>
                    <button type="button" class="btn btn-primary btn-next">Next &rarr;</button>
                </div>
            </div>

            <!-- Step 3: Uploads & Justification -->
            <div class="form-step" data-step="3">
                <h2>Initial Report Uploads</h2>
                <p style="color:var(--text-secondary); font-style:italic; margin-bottom: 1.5rem;">Upload essential reports for NLP analysis. (File selections are not saved locally for security.)</p>
                <div class="form-grid">
                    <div class="form-grid">
                        <div class="input-group">
                            <label for="smoking">Smoking Status (Packs/Years)</label>
                            <input type="text" id="smoking" name="smoking" placeholder="e.g., 20 PY (Pack-Years)">
                        </div>
                        <div class="input-group">
                            <label for="alcohol">Alcohol Consumption</label>
                            <input type="text" id="alcohol" name="alcohol" placeholder="e.g., Moderate (5 drinks/week)">
                        </div>
                        <div class="input-group-full">
                            <label for="family_history">Family History of Cancer/Disease (First-degree relatives)</label>
                            <textarea id="family_history" name="family_history" placeholder="List relevant familial diagnoses (e.g., Mother: Breast Cancer @ 55, Father: Colon Cancer @ 65)"></textarea>
                        </div>
                        <div class="input-group-full">
                            <label for="comorbidities">Existing Comorbidities</label>
                            <input type="text" id="comorbidities" name="comorbidities" placeholder="e.g., Type 2 Diabetes, Hypertension">
                        </div>
                    </div>
                    <div class="form-grid">
                        
                        <div class="input-group">
                            <label for="radio_report">Radiology Report (MRI, CT, PET)</label>
                            <input type="file" id="radio_report" name="radio_report" accept=".pdf,.doc,.txt,.jpg,.png">
                        </div>

                        <div class="input-group">
                            <label for="path_report">Pathology Report / Biopsy Analysis</label>
                            <input type="file" id="path_report" name="path_report" accept=".pdf,.doc,.txt">
                        </div>
                        
                        <div class="input-group">
                            <label for="surgical_notes">Surgical/Procedure Notes</label>
                            <input type="file" id="surgical_notes" name="surgical_notes" accept=".pdf,.doc,.txt">
                        </div>
                        
                        <div class="input-group">
                            <label for="consult_notes">Oncology/Consultation Notes</label>
                            <input type="file" id="consult_notes" name="consult_notes" accept=".pdf,.doc,.txt">
                        </div>

                        <div class="input-group">
                            <label for="genomic_seq">Genomic Sequencing Report (VCF, PDF)</label>
                            <input type="file" id="genomic_seq" name="genomic_seq" accept=".pdf,.vcf,.txt">
                        </div>

                        <div class="input-group">
                            <label for="lab_summary">Structured Lab Summary (CSV, PDF)</label>
                            <input type="file" id="lab_summary" name="lab_summary" accept=".pdf,.csv,.xlsx">
                        </div>
                        
                    </div>
                </div>
                <div class="form-navigation">
                    <button type="button" class="btn btn-secondary btn-prev">&larr; Previous</button>
                    <button type="submit" class="btn btn-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><line x1="19" x2="19" y1="8" y2="14"></line><line x1="22" x2="16" y1="11" y2="11"></line></svg>
                        Create Profile
                    </button>
                </div>
            </div>
        </form>
    </div>

    <script>
        const STORAGE_KEY = 'mddaPatientData';
        const PATIENT_DB_KEY = 'mddaPatientDatabase';

        /**
         * Saves the current form data to localStorage.
         * Note: File inputs are intentionally excluded for security.
         */
        function saveFormData() {
            const form = document.getElementById('patientForm');
            const data = {};
            
            // Iterate over all input, select, and textarea elements
            Array.from(form.elements).forEach(element => {
                if (element.name && element.type !== 'file' && element.type !== 'submit' && element.type !== 'button') {
                    data[element.name] = element.value;
                }
            });

            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                console.log('Form data autosaved.');
            } catch (e) {
                console.error('Error saving to localStorage:', e);
            }
        }

        /**
         * Loads saved data from localStorage and populates the form fields.
         */
        function loadFormData() {
            try {
                const savedData = localStorage.getItem(STORAGE_KEY);
                if (savedData) {
                    const data = JSON.parse(savedData);
                    const form = document.getElementById('patientForm');

                    // Populate fields
                    Object.keys(data).forEach(key => {
                        const element = form.elements[key];
                        if (element) {
                            element.value = data[key];
                        }
                    });
                    console.log('Form data loaded from local storage.');
                }
            } catch (e) {
                console.error('Error loading from localStorage:', e);
            }
        }

        /**
         * Handles the multi-step form navigation.
         */
        function setupWizard() {
            const nextButtons = document.querySelectorAll('.btn-next');
            const prevButtons = document.querySelectorAll('.btn-prev');
            const formSteps = document.querySelectorAll('.form-step');
            const steps = document.querySelectorAll('.stepper-wrapper .step');
            let currentStep = 1;

            const updateSteps = () => {
                formSteps.forEach(step => {
                    step.classList.toggle('active', parseInt(step.dataset.step) === currentStep);
                });
                steps.forEach(step => {
                    const stepNum = parseInt(step.dataset.step);
                    const stepNumberDiv = step.querySelector('.step-number');
                    step.classList.toggle('active', stepNum === currentStep);
                    
                    if (stepNum < currentStep) {
                        step.classList.add('completed');
                        stepNumberDiv.innerHTML = '&#10003;'; // Checkmark
                    } else {
                        stepNumberDiv.textContent = stepNum; // Number
                    }
                });
            };

            nextButtons.forEach(button => {
                button.addEventListener('click', () => {
                    if (currentStep < formSteps.length) {
                        currentStep++;
                        updateSteps();
                    }
                });
            });

            prevButtons.forEach(button => {
                button.addEventListener('click', () => {
                    if (currentStep > 1) {
                        currentStep--;
                        updateSteps();
                    }
                });
            });
        }
        
        /**
         * Calculates age from a date of birth string.
         * @param {string} dobString - The date of birth in 'YYYY-MM-DD' format.
         * @returns {number} The calculated age.
         */
        function calculateAge(dobString) {
            const dob = new Date(dobString);
            const diff_ms = Date.now() - dob.getTime();
            const age_dt = new Date(diff_ms);
            return Math.abs(age_dt.getUTCFullYear() - 1970);
        }

        /**
         * Handles the form submission.
         */
        document.getElementById('patientForm').addEventListener('submit', (e) => {
            e.preventDefault();

            const form = e.target;
            const firstName = form.elements['first_name'].value;
            const lastName = form.elements['last_name'].value;

            // 1. Construct the new patient object
            const newPatient = {
                id: form.elements['patient_id'].value,
                name: `${firstName} ${lastName}`,
                initials: `${firstName.charAt(0)}${lastName.charAt(0)}`.toUpperCase(),
                age: calculateAge(form.elements['dob'].value),
                gender: form.elements['gender'].value,
                bloodType: 'N/A',
                height: 'N/A',
                weight: 'N/A',
                analysisStatus: 'processing', // New patients start as 'processing'
                diagnosis: {
                    condition: form.elements['diagnosis_type'].value || 'Awaiting Analysis',
                    details: form.elements['primary_site'].value || 'N/A',
                    date: form.elements['diagnosis_date'].value,
                    affectedOrgan: 'unknown', // This would be determined by AI in a real app
                    aiKeyFindings: "Data is currently being processed by the NLP and Data Fusion engines. Initial insights will be available shortly.",
                    aiDifferential: "Pending analysis.",
                    aiPrognosis: { risk: "Pending", color: "gray" },
                    aiNextSteps: "Pending analysis.",
                    labResults: {},
                    vitals: { bp: 'N/A', heartRate: 'N/A', temperature: 'N/A' },
                    treatment: 'Pending',
                    treatmentPlan: {
                        medications: [],
                        consultations: [],
                        monitoring: []
                    }
                }
            };

            // 2. Get existing patients, add the new one, and save back to localStorage
            try {
                const patientDB = JSON.parse(localStorage.getItem(PATIENT_DB_KEY) || '{}');
                patientDB[newPatient.id] = newPatient;
                localStorage.setItem(PATIENT_DB_KEY, JSON.stringify(patientDB));

                // 3. Clear the form data and redirect
                localStorage.removeItem(STORAGE_KEY);
                window.location.href = 'patients.html';
            } catch (err) {
                console.error("Failed to save new patient:", err);
                alert("An error occurred while saving the patient. Please check the console.");
            }
        });

        // Initialize the wizard on page load
        setupWizard();
    </script>
</body>
</html>
