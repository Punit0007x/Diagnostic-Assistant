<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MDDA: Patient Directory</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg-1: #f5f3ff; /* Light purple */
      --bg-2: #eff6ff; /* Light blue */
      --surface: #ffffff;
      --muted: #6b7280; /* gray-500 */
      --text: #111827; /* gray-900 */
      --accent: #6366f1; /* indigo-500 */
      --accent-2: #4f46e5; /* indigo-600 */
      --success: #10b981; /* emerald-500 */
      --warning: #f59e0b; /* amber-500 */
      --border: #e5e7eb; /* gray-200 */
      --shadow: 0 6px 20px rgba(16,24,40,0.06);
      --radius: 12px;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
      color: var(--text);
      background: linear-gradient(135deg, var(--bg-1), var(--bg-2));
      min-height: 100vh;
      display: flex;
      overflow-x: hidden; /* Prevent horizontal scroll from animations */
      flex-direction: column;
    }

    /* HEADER */
    .top-header {
      background: linear-gradient(90deg, rgba(255,255,255,0.85), rgba(255,255,255,0.9));
      border-bottom: 1px solid var(--border);
      padding: 18px 28px;
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 6px 20px rgba(16,24,40,0.04);
      backdrop-filter: blur(4px);
    }

    .top-header .header-inner {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .header-actions {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-shrink: 0; /* Prevent buttons from shrinking */
    }

    .top-header .logo {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: linear-gradient(180deg, var(--accent), var(--accent-2));
      box-shadow: 0 6px 18px rgba(6,182,212,0.12);
    }

    .top-header .logo svg {
      width: 26px;
      height: 26px;
      display: block;
    }

    /* small logo pulse */
    .top-header .logo { animation: pulse 6s ease-in-out infinite; }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.04); }
    }

    .top-header .title-wrap h1 {
      margin: 0;
      font-size: 1.25rem;
      color: var(--text);
      font-weight: 800;
      letter-spacing: 0.2px;
    }

    .top-header .title-wrap .tagline {
      margin: 2px 0 0 0;
      font-size: 0.85rem;
      color: var(--muted);
      font-weight: 500;
    }

    /* CONTAINER */
    .container {
      flex-grow: 1;
      padding: 32px 6%;
    }

    /* CONTROLS BAR */
    .controls-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
    }

    .controls-bar .search-wrapper {
      position: relative;
      flex-grow: 1;
    }

    .controls-bar .search-wrapper input {
      width: 100%;
      padding-left: 40px;
      box-sizing: border-box;
    }

    .controls-bar .search-icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 16px;
      color: var(--muted);
      pointer-events: none;
    }

    .controls-bar label {
      font-weight: 600;
      text-transform: uppercase;
      color: var(--muted);
      font-size: 0.75rem;
    }

    .controls-bar input,
    .controls-bar select {
      flex-grow: 1;
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #fafbfd;
      color: var(--text);
      font-size: 1rem;
      transition: box-shadow 0.15s ease, border-color 0.15s ease;
    }

    .controls-bar input:focus,
    .controls-bar select:focus {
      border-color: var(--accent);
      box-shadow: 0 4px 14px rgba(37,99,235,0.12);
      outline: none;
    }

    /* NEW CARD-BASED LAYOUT */
    .patient-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 1.5rem;
      margin-top: 1.5rem;
    }

    .patient-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.5rem;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .patient-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 10px 25px rgba(16,24,40,0.08);
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }

    /* TABLE CONTAINER */
    .patient-table-container {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      margin-top: 22px;
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    .patient-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
    }

    .patient-table thead {
      background: linear-gradient(90deg, #fbfdff, #f7fbff);
    }
    
    .patient-table th {
      text-align: left;
      padding: 16px 18px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.6px;
      font-size: 0.75rem;
      border-bottom: 1px solid var(--border);
    }
    .patient-table th.avatar-col { width: 64px; }

    .patient-table td {
      padding: 16px 18px;
      border-top: 1px solid var(--border);
      color: var(--text);
      vertical-align: middle;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #fff;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      box-shadow: 0 6px 18px rgba(6,182,212,0.08);
    }
    .patient-table tbody tr {
      transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
    }

    .patient-table tbody tr:nth-child(odd) {
      background: #ffffff;
    }

    .patient-table tbody tr:nth-child(even) {
      background: #fbfeff;
    }

    .patient-table tbody tr:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(6,182,212,0.06);
      background: #f8ffff;
    }

    .row-actions { display: flex; gap: 8px; }

    /* STATUS BADGES */
    .status-badge {
      padding: 6px 12px;
      border-radius: 999px;
      padding: 8px 14px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      text-align: center;
      transition: transform 0.12s ease, box-shadow 0.12s ease;
      font-size: 0.9rem;
    }

    .btn-primary-action {
      background: var(--accent);
      color: #ffffff;
      box-shadow: 0 4px 14px rgba(99, 102, 241, 0.25);
      border: none;
      border-radius: 10px;
      padding: 9px 16px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary-action:hover,
    .btn-primary-action:focus {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
      outline: none;
    }

    .btn-secondary-action {
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 9px 16px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-secondary-action:hover,
    .btn-secondary-action:focus {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(100, 116, 139, 0.1);
      outline: none;
    }

    /* Diagnosis Cell Styling */
    .diagnosis-cell {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .diagnosis-cell strong {
      color: var(--text);
      font-size: 0.9rem;
    }

    .diagnosis-cell .diagnosis-details {
      color: var(--muted);
      font-size: 0.8rem;
      font-style: italic;
    }

    /* Status Badge Enhancements */
    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .status-badge::before {
      content: '';
      width: 6px;
      height: 6px;
      border-radius: 50%;
      display: inline-block;
    }

    .status-ready {
      background: rgba(16, 185, 129, 0.1); /* emerald/10 */
      color: #047857; /* emerald-700 */
    }

    .status-ready::before {
      background: var(--success);
      box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2); /* emerald/20 */
    }

    .status-processing {
      background: rgba(245, 158, 11, 0.1); /* amber/10 */
      color: #b45309; /* amber-700 */
    }

    .status-processing::before {
      background: var(--warning);
      box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2); /* amber/20 */
      animation: pulse 1.5s infinite;
    }

    /* Action Buttons Container */
    .action-buttons {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    /* Avatar Enhancements */
    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.9rem;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s ease;
    }

    .avatar:hover {
      transform: scale(1.1);
    }

    /* FOOTER */
    .footer {
      text-align: center;
      padding: 20px;
      background: transparent;
      color: var(--muted);
      font-size: 0.9rem;
      letter-spacing: 0.3px;
      margin-top: 24px;
    }

    /* Sortable Table Headers */
    .patient-table th.sortable {
      cursor: pointer;
      user-select: none;
      position: relative;
      transition: background-color 0.2s ease;
    }
    .patient-table th.sortable:hover {
      background-color: #f0f9ff;
    }
    .patient-table th .sort-indicator {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--accent);
    }

    /* Search Highlighting */
    .highlight {
      background-color: #fef08a; /* yellow-200 */
      border-radius: 3px;
      padding: 0 2px;
      font-weight: 600;
      color: #713f12; /* amber-900 */
    }

    /* Focus Outline */
    .controls-bar input:focus, .controls-bar select:focus, .table-action-button:focus {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    /* Action Button for Toggling Status */
    .btn-toggle-status {
      background: transparent;
      color: var(--accent);
      border: 1px solid rgba(99, 102, 241, 0.4);
    }
    .btn-toggle-status:hover {
      background: rgba(99, 102, 241, 0.1);
    }

    /* Delete Button */
    .btn-delete-action {
      background: transparent;
      color: #ef4444; /* red-500 */
      border: 1px solid rgba(239, 68, 68, 0.4);
    }
    .btn-delete-action:hover { background: rgba(239, 68, 68, 0.1); }

    /* Row Animation */
    .animate-row {
      opacity: 0;
      animation: fadeInUp 0.6s ease-out forwards;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Confirmation Modal */
    .modal-backdrop {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(30, 41, 59, 0.8);
        backdrop-filter: blur(4px);
        display: flex; align-items: center; justify-content: center;
        z-index: 1000; opacity: 0; visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .modal-backdrop.visible { opacity: 1; visibility: visible; }
    .modal-container {
        background: var(--surface); padding: 2rem; border-radius: var(--radius);
        width: 90%; max-width: 500px; box-shadow: var(--shadow);
        transform: scale(0.95); transition: transform 0.3s ease;
    }
    .modal-backdrop.visible .modal-container { transform: scale(1); }
    .modal-title {
        font-size: 1.5rem; font-weight: 700; color: var(--text); margin-bottom: 1rem;
    }
    .modal-content { color: var(--muted); margin-bottom: 1.5rem; }
    .modal-actions { display: flex; gap: 1rem; }
    .modal-button {
        flex-grow: 1; padding: 0.75rem; border-radius: 8px;
        font-weight: 600; cursor: pointer; transition: all 0.2s ease;
    }
    .modal-button-confirm {
        background-color: #dc2626; /* red-600 */
        color: white; border: none;
    }
    .modal-button-confirm:hover { background-color: #b91c1c; }
    .modal-button-cancel {
        background-color: #e5e7eb; /* gray-200 */
        color: #374151; /* gray-700 */ border: none;
    }
    .modal-button-cancel:hover { background-color: #d1d5db; }

    /* --- Responsive Design --- */
    @media (max-width: 900px) {
      .container {
        padding: 24px 4%;
      }

      /* Convert table to card layout */
      .patient-table thead {
        display: none; /* Hide table headers on mobile */
      }

      .patient-table tbody, .patient-table tr {
        display: block;
      }

      .patient-table tr {
        margin-bottom: 1rem;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: none;
        padding: 8px;
      }

      .patient-table tr:hover {
        transform: none;
        box-shadow: var(--shadow);
      }

      .patient-table td {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 8px;
        border: none;
        border-bottom: 1px solid var(--border);
      }

      .patient-table td:last-child {
        border-bottom: none;
      }

      .patient-table td::before {
        content: attr(data-label);
        font-weight: 600;
        color: var(--muted);
        padding-right: 16px;
      }

      .patient-table .avatar-col { display: none; } /* Hide avatar column */

      .controls-bar {
        flex-direction: column;
      }
    }

    @media (max-width: 640px) {
      .top-header .header-inner {
        flex-direction: column;
        gap: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="top-header">
    <div class="header-inner">
      <div style="flex:1;display:flex;gap:14px;align-items:center;">
        <div class="logo" aria-hidden="true">
          <!-- simple medical cross SVG -->
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <rect x="9" y="3" width="6" height="18" rx="1" fill="white" opacity="0.95" />
            <rect x="3" y="9" width="18" height="6" rx="1" fill="white" opacity="0.95" />
          </svg>
        </div>
        <div class="title-wrap">
          <h1>MDDA</h1>
          <div class="tagline">Patient Directory • Insight at a glance</div>
        </div>
      </div>

      <div class="header-actions">
        <a class="table-action-button btn-primary-action" href="add_patient.html">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
          Add Patient
        </a>
        <a class="table-action-button btn-secondary-action" href="#">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
          Export CSV
        </a>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="controls-bar">
      <label for="search">Search:</label>
      <div class="search-wrapper">
        <span class="search-icon" aria-hidden="true">🔍</span>
        <input type="text" id="search" placeholder="Patient ID, Name, or Diagnosis..." />
      </div>

      <label for="status-filter">Status:</label>
      <select id="status-filter">
        <option value="">All Statuses</option>
        <option value="Dashboard Ready">Dashboard Ready</option>
        <option value="Processing">Processing</option>
      </select>

      <label for="sort-by">Sort By:</label>
      <select id="sort-by">
        <option value="name-asc">Name (A-Z)</option>
        <option value="name-desc">Name (Z-A)</option>
        <option value="age-asc">Age (Youngest First)</option>
        <option value="age-desc">Age (Oldest First)</option>
      </select>
    </div>

    <div id="patient-grid" class="patient-grid">
      <!-- Patient cards will be dynamically inserted here -->
    </div>
  </div>

  <div class="footer">
    MDDA © 2024. All rights reserved.
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="delete-confirm-modal" class="modal-backdrop">
    <div class="modal-container">
        <h3 class="modal-title">Confirm Deletion</h3>
        <p id="delete-modal-content" class="modal-content">Are you sure you want to permanently delete this patient record? This action cannot be undone.</p>
        <div class="modal-actions">
            <button id="cancel-delete-btn" class="modal-button modal-button-cancel">Cancel</button>
            <button id="confirm-delete-btn" class="modal-button modal-button-confirm">Delete Patient</button>
        </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const searchInput = document.getElementById("search");
      const statusFilter = document.getElementById("status-filter");
      const sortBy = document.getElementById("sort-by");
      let patientCards = []; // Will be populated dynamically

      function highlightText(text, query) {
        if (!query) return text;
        const regex = new RegExp(`(${query})`, 'gi');
        return text.replace(regex, '<span class="highlight">$1</span>');
      }

      function clearHighlights() {
        patientCards.forEach(card => {
          card.querySelectorAll('.searchable').forEach(el => {
            el.innerHTML = el.dataset.originalText;
          });
        });
      }

      function filterPatients() {
        clearHighlights();
        const searchTerm = searchInput.value.toLowerCase();
        const selectedStatus = statusFilter.value;

        patientCards.forEach((card) => {
          const patientId = card.dataset.patientId.toLowerCase();
          const patientName = card.dataset.patientName.toLowerCase();
          const diagnosis = card.dataset.diagnosis.toLowerCase();
          const dataStatus = card.dataset.status;

          const matchesSearch =
            patientId.includes(searchTerm) ||
            patientName.includes(searchTerm) ||
            diagnosis.includes(searchTerm);
          const matchesStatus = !selectedStatus || dataStatus.toLowerCase().includes(selectedStatus.toLowerCase());

          if (matchesSearch && matchesStatus) {
            card.style.display = "";
            if (searchTerm) {
              card.querySelectorAll('.searchable').forEach(el => {
                el.innerHTML = highlightText(el.dataset.originalText, searchTerm);
              });
            }
          } else {
            card.style.display = "none";
          }
        });
      }

      searchInput.addEventListener("input", filterPatients);
      statusFilter.addEventListener("change", filterPatients);

      // --- Sorting Logic ---
      sortBy.addEventListener('change', () => {
        const grid = document.getElementById('patient-grid');
        const [key, direction] = sortBy.value.split('-');

        const sortedCards = [...patientCards].sort((a, b) => {
          let valA = a.dataset[key];
          let valB = b.dataset[key];

          if (key === 'age') {
            valA = parseInt(valA, 10);
            valB = parseInt(valB, 10);
          }

          if (valA < valB) return direction === 'asc' ? -1 : 1;
          if (valA > valB) return direction === 'asc' ? 1 : -1;
          return 0;
        });

        sortedCards.forEach(card => grid.appendChild(card));
      });

      loadPatients(); // Load patients from localStorage

      // --- Status Toggle ---
      window.toggleStatus = function(button) {
        const card = button.closest('.patient-card');
        const patientId = card.dataset.patientId;
        const statusCell = card.querySelector('.card-footer');
        const statusBadge = statusCell.querySelector('.status-badge');
        const viewReportButton = card.querySelector('.btn-primary-action');

        // Update UI
        card.dataset.status = "Dashboard Ready";
        statusBadge.className = 'status-badge status-ready';
        statusBadge.textContent = 'Analysis Complete';
        button.style.display = 'none';
        if(viewReportButton) viewReportButton.style.display = 'inline-flex';

        // Update localStorage
        const PATIENT_DB_KEY = 'mddaPatientDatabase';
        try {
            const patientDB = JSON.parse(localStorage.getItem(PATIENT_DB_KEY) || '{}');
            if (patientDB[patientId]) {
                patientDB[patientId].analysisStatus = 'complete';
                localStorage.setItem(PATIENT_DB_KEY, JSON.stringify(patientDB));
            }
        } catch (err) {
            console.error("Failed to update patient status in localStorage:", err);
        }
      }

      // --- Export Visible to CSV ---
      const exportCsvButton = document.querySelector('.btn-secondary-action[href="#"]');
      if (exportCsvButton) {
        exportCsvButton.addEventListener('click', (e) => { // This logic needs to be updated for cards
          e.preventDefault();
          const visibleRows = Array.from(rows).filter(row => row.style.display !== 'none');
          if (visibleRows.length === 0) {
            alert("No visible patients to export.");
            return;
          }

          const headers = Array.from(document.querySelectorAll('.patient-table th'))
            .map(th => th.textContent.trim()).slice(1, -1); // Skip avatar and actions

          let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n";

          visibleRows.forEach(row => {
            const rowData = Array.from(row.cells).slice(1, -1).map(cell => `"${cell.textContent.trim()}"`);
            csvContent += rowData.join(",") + "\n";
          });

          const encodedUri = encodeURI(csvContent);
          const link = document.createElement("a");
          link.setAttribute("href", encodedUri);
          link.setAttribute("download", "visible_patients.csv");
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        });
      }

      // --- Mock Export Record ---
      window.exportRecord = function(patientId) {
        alert(`Exporting single record for patient: ${patientId}`);
        // In a real app, this would trigger a download of a single record's data.
      }

      /**
       * Sets up and handles the delete confirmation modal.
       */
      function setupDeleteModal() {
          const modal = document.getElementById('delete-confirm-modal');
          const confirmBtn = document.getElementById('confirm-delete-btn');
          const cancelBtn = document.getElementById('cancel-delete-btn');
          const modalContent = document.getElementById('delete-modal-content');
          let patientIdToDelete = null;

          window.confirmDeletePatient = (patientId, patientName) => {
              patientIdToDelete = patientId;
              modalContent.innerHTML = `Are you sure you want to permanently delete the record for <strong>${patientName}</strong> (ID: ${patientId})? This action cannot be undone.`;
              modal.classList.add('visible');
          };

          const closeModal = () => modal.classList.remove('visible');

          confirmBtn.addEventListener('click', () => {
              if (patientIdToDelete) {
                  const PATIENT_DB_KEY = 'mddaPatientDatabase';
                  const patientDB = JSON.parse(localStorage.getItem(PATIENT_DB_KEY) || '{}');
                  delete patientDB[patientIdToDelete];
                  localStorage.setItem(PATIENT_DB_KEY, JSON.stringify(patientDB));
                  
                  // Reload the table to reflect the deletion
                  loadPatients();
              }
              closeModal();
          });

          cancelBtn.addEventListener('click', closeModal);
          modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
      }
      setupDeleteModal();

      /**
       * If no patient data exists in localStorage, this function populates it
       * with a default set of demo patients for demonstration purposes.
       */
      function initializeDemoData() {
          const PATIENT_DB_KEY = 'mddaPatientDatabase';
          const existingDB = localStorage.getItem(PATIENT_DB_KEY);

          if (!existingDB || Object.keys(JSON.parse(existingDB)).length === 0) {
              console.log("No patient data found. Initializing with demo patients.");
              const demoPatientData = {
                  'P-2025-001': { // Changed name
                      id: 'P-2025-001', name: 'Priya Sharma', initials: 'PS', age: 54, gender: 'Female', bloodType: 'A+', height: '165 cm', weight: '62 kg',
                      analysisStatus: 'complete',
                      diagnosis: {
                          condition: 'Hepatocellular Carcinoma', details: '5.2cm tumor, Segment VI', date: 'Sept 28, 2025',
                          affectedOrgan: 'liver',
                          aiKeyFindings: "This 54-year-old female presents a clinical picture highly indicative of Hepatocellular Carcinoma (HCC). The most significant finding is a markedly elevated Alpha-Fetoprotein (AFP) level of 420 ng/mL, which is a strong tumor marker for HCC. This is corroborated by imaging studies that identify a distinct 5.2cm lesion in segment VI of the liver. Encouragingly, her liver function appears to be well-preserved at this time, as evidenced by normal Albumin and Total Bilirubin levels.",
                          aiDifferential: "While metastatic disease from another primary cancer is always a consideration for a solitary liver lesion, it is less probable here given the absence of a known primary tumor elsewhere and the strong AFP signal. Benign possibilities such as a hepatic adenoma are also considered highly unlikely in the context of such a high AFP level, which is not typically associated with adenomas.",
                          aiPrognosis: { risk: "Moderate", color: "orange" },
                          aiNextSteps: "The immediate priority is to arrange a surgical consultation to evaluate the feasibility of resection, which offers the best curative potential. To aid the surgical planning, a triple-phase CT scan is strongly recommended. This will provide critical details about the lesion's vascularity and its relationship to major blood vessels, which is essential for determining resectability.",
                          labResults: { 'Alpha-Fetoprotein (AFP)': { value: '420 ng/mL', range: '< 10 ng/mL', status: 'High', history: [120, 250, 380, 420] }, 'Albumin': { value: '3.8 g/dL', range: '3.5-5.0 g/dL', status: 'Normal' }, 'Total Bilirubin': { value: '1.1 mg/dL', range: '0.3-1.2 mg/dL', status: 'Normal' }, 'ALT': { value: '55 U/L', range: '7-56 U/L', status: 'High', history: [0.8, 0.9, 1.0, 1.1] } },
                          vitals: { bp: '120/80', heartRate: '72 bpm', temperature: '36.8°C' },
                          treatment: 'Surgical resection planned',
                          treatmentPlan: { medications: [ { name: 'Lactulose', dosage: '30ml PO BID', purpose: 'To prevent hepatic encephalopathy' }, { name: 'Vitamin K', dosage: '10mg IV daily', purpose: 'To correct coagulopathy pre-op' } ], consultations: [ { specialty: 'Surgical Oncology', date: 'Oct 15, 2025', status: 'Completed' }, { specialty: 'Anesthesiology', date: 'Oct 18, 2025', status: 'Scheduled' } ], monitoring: ['Weekly LFTs and coagulation profile', 'Monitor for signs of ascites or edema', 'Post-op imaging at 1 and 3 months'] }
                      }
                  }, // End of P-2025-001
                  'P-2025-002': { // Changed name
                      id: 'P-2025-002', name: 'Rohan Mehta', initials: 'RM', age: 67, gender: 'Male', bloodType: 'O-', height: '178 cm', weight: '85 kg',
                      analysisStatus: 'processing',
                      diagnosis: {
                          condition: 'NSCLC (Adenocarcinoma)', details: '2.8cm RUL nodule, Stage IIB', date: 'Oct 02, 2025',
                          affectedOrgan: 'lung-right',
                          aiKeyFindings: "The patient, a 67-year-old male, has a confirmed 2.8cm nodule in the right upper lobe, identified via imaging. The diagnosis of Non-Small Cell Lung Cancer (NSCLC), specifically adenocarcinoma, is supported by an elevated Carcinoembryonic Antigen (CEA) level of 15 ng/mL. Additionally, the patient's lab work reveals a mild but notable anemia, indicated by a low hemoglobin level, which may be related to the chronic disease process.",
                          aiDifferential: "Infectious causes, such as a tuberculoma or a fungal granuloma, can mimic a solitary lung nodule on imaging. However, the presence of an elevated CEA tumor marker significantly raises the suspicion for malignancy and makes these infectious etiologies less likely. The combination of the imaging finding and the specific biomarker profile provides a strong basis for the current diagnosis.",
                          aiPrognosis: { risk: "High", color: "red" },
                          aiNextSteps: "It is appropriate to proceed with the planned systemic treatment using a Cisplatin/Pemetrexed chemotherapy regimen. To complete the staging workup and ensure there is no distant disease, a PET scan is highly recommended. This will help confirm that the cancer is confined to the chest. Furthermore, the patient's hemoglobin should be closely monitored, and iron supplementation should be considered to manage the anemia.",
                          labResults: { 'CEA': { value: '15 ng/mL', range: '< 5 ng/mL', status: 'High', history: [4, 8, 11, 15] }, 'Hemoglobin': { value: '13.1 g/dL', range: '13.5-17.5 g/dL', status: 'Low', history: [14.5, 14.0, 13.5, 13.1] }, 'Creatinine': { value: '1.0 mg/dL', range: '0.7-1.3 mg/dL', status: 'Normal' }, 'LDH': { value: '250 U/L', range: '140-280 U/L', status: 'Normal' } },
                          vitals: { bp: '135/85', heartRate: '80 bpm', temperature: '37.0°C' },
                          treatment: 'Chemotherapy (Cisplatin/Pemetrexed)',
                          treatmentPlan: { medications: [ { name: 'Cisplatin', dosage: '75 mg/m²', purpose: 'Cycle 1 of 4' }, { name: 'Pemetrexed', dosage: '500 mg/m²', purpose: 'Cycle 1 of 4' }, { name: 'Ondansetron', dosage: '8mg PO PRN', purpose: 'For nausea' } ], consultations: [ { specialty: 'Radiation Oncology', date: 'Oct 25, 2025', status: 'Scheduled' } ], monitoring: ['Monitor CBC and renal function before each cycle', 'Follow-up CT scan after 2 cycles to assess response'] }
                      }
                  }, // End of P-2025-002
                  'P-2025-003': { // Changed name
                      id: 'P-2025-003', name: 'Anjali Gupta', initials: 'AG', age: 42, gender: 'Female', bloodType: 'B+', height: '160 cm', weight: '58 kg',
                      analysisStatus: 'complete',
                      diagnosis: {
                          condition: 'Breast Cancer', details: 'IDC, Grade II, T2N1M0', date: 'Aug 15, 2025',
                          affectedOrgan: 'breast-left',
                          aiKeyFindings: "This 42-year-old female has a biopsy-confirmed diagnosis of Invasive Ductal Carcinoma. The tumor's biological profile is favorable, being Estrogen Receptor (ER)-positive and HER2-negative, which opens the door for effective hormone therapy. The elevated CA 15-3 tumor marker is consistent with the tumor burden. The clinical stage, T2N1M0, indicates a localized tumor with involvement of nearby lymph nodes but, crucially, no evidence of distant metastasis.",
                          aiDifferential: "With a definitive biopsy result, a differential diagnosis is not applicable. The focus shifts entirely from diagnosis to treatment planning based on the established pathology and staging.",
                          aiPrognosis: { risk: "Low", color: "green" },
                          aiNextSteps: "The recommended course of action is multi-faceted, beginning with a lumpectomy to remove the tumor, followed by adjuvant radiation to reduce the risk of local recurrence. Given the ER-positive status, initiating hormone therapy (such as Tamoxifen or an Aromatase Inhibitor) is critical. Additionally, offering genetic counseling and considering BRCA1/2 testing would be prudent to assess for hereditary cancer risk.",
                          labResults: { 'CA 15-3': { value: '45 U/mL', range: '< 30 U/mL', status: 'High', history: [25, 30, 38, 45] }, 'Estrogen Receptor': { value: 'Positive', range: 'N/A', status: 'Positive' }, 'HER2/neu': { value: 'Negative', range: 'N/A', status: 'Negative' }, 'Alkaline Phosphatase': { value: '110 U/L', range: '44-147 U/L', status: 'Normal' } },
                          vitals: { bp: '118/75', heartRate: '68 bpm', temperature: '36.7°C' },
                          treatment: 'Lumpectomy followed by radiation and hormone therapy',
                          treatmentPlan: { medications: [ { name: 'Tamoxifen', dosage: '20mg PO daily', purpose: 'Adjuvant hormone therapy' } ], consultations: [ { specialty: 'Radiation Oncology', date: 'Sep 10, 2025', status: 'Completed' }, { specialty: 'Medical Oncology', date: 'Sep 15, 2025', status: 'Completed' } ], monitoring: ['Annual mammogram', 'Regular follow-up with medical oncology'] }
                      }
                  }, // End of P-2025-003
                  'P-2025-004': { // Changed name and gender
                      id: 'P-2025-004', name: 'Aarav Patel', initials: 'AP', age: 29, gender: 'Male', bloodType: 'AB+', height: '170 cm', weight: '65 kg',
                      analysisStatus: 'processing',
                      diagnosis: {
                          condition: 'Type 1 Diabetes', details: 'HbA1c: 8.2%, Insulin Therapy', date: 'Jan 20, 2024',
                          affectedOrgan: 'pancreas',
                          aiKeyFindings: "This 29-year-old female's data points clearly to a diagnosis of Type 1 Diabetes with suboptimal glycemic control. The HbA1c of 8.2% reflects a high average blood sugar over the past three months. The core issue is confirmed by a very low C-Peptide level (0.1 ng/mL), which signifies that her pancreas is producing minimal to no insulin on its own. This is further supported by a high fasting glucose reading of 150 mg/dL.",
                          aiDifferential: "The possibility of Type 2 Diabetes is effectively ruled out by the C-Peptide result. In Type 2 Diabetes, especially in its earlier stages, C-Peptide levels are often normal or even high as the body tries to overcome insulin resistance. The extremely low level seen here is the classic hallmark of autoimmune beta-cell destruction that defines Type 1 Diabetes.",
                          aiPrognosis: { risk: "Chronic/Managed", color: "blue" },
                          aiNextSteps: "To improve management, a consultation with an endocrinologist is strongly recommended to fine-tune her insulin pump settings. The implementation of a continuous glucose monitoring (CGM) system would be a game-changer, providing invaluable real-time data to guide therapy. A referral to a registered dietitian is also crucial to reinforce skills in carbohydrate counting and meal planning.",
                          labResults: { 'HbA1c': { value: '8.2%', range: '< 5.7%', status: 'High', history: [7.5, 7.8, 8.0, 8.2] }, 'Fasting Glucose': { value: '150 mg/dL', range: '70-100 mg/dL', status: 'High', history: [130, 145, 140, 150] }, 'C-Peptide': { value: '0.1 ng/mL', range: '0.5-2.0 ng/mL', status: 'Low', history: [0.3, 0.2, 0.1, 0.1] }, 'GAD Antibodies': { value: 'Positive', range: 'Negative', status: 'High' } },
                          vitals: { bp: '110/70', heartRate: '75 bpm', temperature: '36.9°C' },
                          treatment: 'Insulin pump therapy and continuous glucose monitoring',
                          treatmentPlan: { medications: [ { name: 'Insulin Aspart', dosage: 'Via pump, variable', purpose: 'Basal and bolus insulin' } ], consultations: [ { specialty: 'Endocrinologist', date: 'Nov 05, 2024', status: 'Scheduled' }, { specialty: 'Registered Dietitian', date: 'Nov 12, 2024', status: 'Scheduled' } ], monitoring: ['Review CGM data weekly', 'Quarterly HbA1c checks', 'Annual kidney and eye screening'] }
                      }
                  }, // End of P-2025-004
                  'P-2025-005': { // Changed name
                      id: 'P-2025-005', name: 'Vikram Rathore', initials: 'VR', age: 36, gender: 'Male', bloodType: 'O+', height: '182 cm', weight: '78 kg',
                      analysisStatus: 'complete',
                      diagnosis: {
                          condition: 'Asthma', details: 'Mild persistent, Inhaler therapy', date: 'Mar 10, 2023',
                          affectedOrgan: 'lungs',
                          aiKeyFindings: "This patient has an established diagnosis of mild persistent asthma that appears to be well-managed. His baseline lung function is good, with an FEV1 within the normal predicted range. The normal eosinophil count suggests that his asthma is either non-allergic in nature or that any allergic component is being effectively controlled by his current medication. Most importantly, the patient's self-reported symptom control is effective.",
                          aiDifferential: "As this is a long-standing and stable diagnosis, a differential diagnosis is not currently warranted. The clinical picture is entirely consistent with well-controlled asthma.",
                          aiPrognosis: { risk: "Very Low", color: "green" },
                          aiNextSteps: "The primary recommendation is to continue the current successful treatment plan. It is important to reinforce the patient's understanding of the need for consistent daily use of his Fluticasone inhaler to manage underlying inflammation, rather than relying solely on the rescue inhaler. Providing him with an updated, clear Asthma Action Plan for how to handle any potential flare-ups is also advised.",
                          labResults: { 'FEV1': { value: '85% predicted', range: '>80% predicted', status: 'Normal' }, 'Eosinophils': { value: '250 cells/mcL', range: '< 500 cells/mcL', status: 'Normal' }, 'Total IgE': { value: '120 IU/mL', range: '< 100 IU/mL', status: 'High' } },
                          vitals: { bp: '125/80', heartRate: '65 bpm', temperature: '36.6°C' },
                          treatment: 'Albuterol inhaler (as needed), Fluticasone (daily)',
                          treatmentPlan: { medications: [ { name: 'Fluticasone', dosage: '1 puff BID', purpose: 'Controller medication' }, { name: 'Albuterol', dosage: '2 puffs PRN', purpose: 'Rescue medication' } ], consultations: [ { specialty: 'Pulmonology', date: 'Mar 10, 2024', status: 'Completed' } ], monitoring: ['Annual spirometry testing', 'Review inhaler technique at each visit'] }
                      }
                  }, // End of P-2025-005
                  'P-2025-006': { // Changed name
                      id: 'P-2025-006', name: 'Sunita Desai', initials: 'SD', age: 61, gender: 'Female', bloodType: 'A-', height: '155 cm', weight: '70 kg',
                      analysisStatus: 'processing',
                      diagnosis: {
                          condition: 'Chronic Kidney Disease', details: 'Stage 3, eGFR: 45', date: 'Jul 22, 2025',
                          affectedOrgan: 'kidneys',
                          aiKeyFindings: "This 61-year-old female's lab results indicate Stage 3 Chronic Kidney Disease (CKD). This is defined by her estimated Glomerular Filtration Rate (eGFR) of 45 mL/min/1.73m². The diagnosis is further substantiated by elevated levels of Serum Creatinine and BUN, both of which confirm reduced kidney function. Her co-existing hypertension (140/90 mmHg) is significant, as it is both a potential cause and a consequence of her kidney disease.",
                          aiDifferential: "The diagnosis points towards a chronic process. While an Acute Kidney Injury (AKI) is a possibility, it is less likely given the context. To be certain, a review of her historical creatinine levels is recommended to confirm a gradual decline in function over time, which is characteristic of CKD rather than a sudden drop seen in AKI.",
                          aiPrognosis: { risk: "Moderate", color: "orange" },
                          aiNextSteps: "Management should focus on slowing disease progression. It is crucial to continue Lisinopril, as it provides both blood pressure control and a protective effect on the kidneys. A referral to a renal dietitian is essential for counseling on a diet low in sodium and potassium. The patient must be educated to strictly avoid NSAIDs, which can further harm the kidneys. A follow-up lab panel in 3 months is necessary to monitor the eGFR trend.",
                          labResults: { 'eGFR': { value: '45 mL/min/1.73m²', range: '>90', status: 'Low', history: [55, 50, 48, 45] }, 'Serum Creatinine': { value: '1.5 mg/dL', range: '0.6-1.1 mg/dL', status: 'High', history: [1.2, 1.3, 1.4, 1.5] }, 'BUN': { value: '25 mg/dL', range: '7-20 mg/dL', status: 'High', history: [20, 22, 24, 25] }, 'UACR': { value: '50 mg/g', range: '< 30 mg/g', status: 'High' } },
                          vitals: { bp: '140/90', heartRate: '78 bpm', temperature: '36.8°C' },
                          treatment: 'Lisinopril for blood pressure control, dietary restrictions',
                          treatmentPlan: { medications: [ { name: 'Lisinopril', dosage: '20mg PO daily', purpose: 'Blood pressure & renal protection' }, { name: 'Atorvastatin', dosage: '40mg PO daily', purpose: 'Cardiovascular risk reduction' } ], consultations: [ { specialty: 'Nephrology', date: 'Oct 20, 2025', status: 'Scheduled' }, { specialty: 'Renal Dietitian', date: 'Aug 10, 2025', status: 'Completed' } ], monitoring: ['Monitor eGFR and electrolytes every 3 months', 'Maintain BP < 130/80 mmHg'] }
                      }
                  }, // End of P-2025-006
                  'P-2025-007': { // Changed name
                      id: 'P-2025-007', name: 'Arjun Kumar', initials: 'AK', age: 48, gender: 'Male', bloodType: 'B-', height: '175 cm', weight: '72 kg',
                      analysisStatus: 'complete',
                      diagnosis: {
                          condition: 'Glioblastoma', details: '4.5cm mass in left temporal lobe', date: 'Oct 18, 2025',
                          affectedOrgan: 'brain',
                          aiKeyFindings: "A 48-year-old male presents with a 4.5cm ring-enhancing mass in the left temporal lobe, identified on contrast-enhanced MRI. The imaging characteristics are highly suggestive of a high-grade glioma, most likely Glioblastoma (GBM). The patient's recent onset of seizures and headaches aligns with the location and size of the lesion. Lab work is largely unremarkable, which is common in primary brain tumors.",
                          aiDifferential: "While the primary differential is Glioblastoma, other possibilities include a solitary brain metastasis from an unknown primary cancer or, less likely, a primary CNS lymphoma. However, the ring-enhancement and surrounding edema on MRI strongly favor GBM. An abscess is also a remote possibility but is less likely without signs of systemic infection.",
                          aiPrognosis: { risk: "High", color: "red" },
                          aiNextSteps: "Immediate neurosurgical consultation is paramount for biopsy and maximal safe resection of the tumor. Post-operative chemoradiation with temozolomide is the standard of care and should be planned. Genetic analysis of the tumor tissue for MGMT promoter methylation status is critical for prognostic and treatment planning.",
                          labResults: { 'CBC': { value: 'Normal', range: 'N/A', status: 'Normal' }, 'CMP': { value: 'Normal', range: 'N/A', status: 'Normal' }, 'GFAP': { value: 'Elevated', range: 'N/A', status: 'High', history: [1,1,1,1] }, 'CRP': { value: '0.5 mg/L', range: '< 3.0 mg/L', status: 'Normal' } },
                          vitals: { bp: '130/85', heartRate: '70 bpm', temperature: '37.1°C' },
                          treatment: 'Surgical Resection + Chemoradiation',
                          treatmentPlan: { medications: [ { name: 'Dexamethasone', dosage: '4mg PO QID', purpose: 'To reduce cerebral edema' }, { name: 'Levetiracetam', dosage: '500mg PO BID', purpose: 'Seizure prophylaxis' } ], consultations: [ { specialty: 'Neurosurgery', date: 'Oct 19, 2025', status: 'Completed' }, { specialty: 'Neuro-Oncology', date: 'Oct 22, 2025', status: 'Scheduled' } ], monitoring: ['Weekly CBC during chemotherapy', 'MRI brain every 2 months post-treatment'] }
                      }
                  }, // End of P-2025-007
              };
              localStorage.setItem(PATIENT_DB_KEY, JSON.stringify(demoPatientData));
          }
      }

      /**
       * Loads patients from localStorage and populates the table.
       */
      function loadPatients() {
          initializeDemoData(); // Check for and load demo data if needed
          const PATIENT_DB_KEY = 'mddaPatientDatabase';
          const patientDB = JSON.parse(localStorage.getItem(PATIENT_DB_KEY) || '{}');
          const grid = document.getElementById('patient-grid');
          grid.innerHTML = ''; // Clear existing cards

          if (Object.keys(patientDB).length === 0) {
              grid.innerHTML = '<p class="text-center p-8 text-gray-500 col-span-full">No patients found. Please add a new patient.</p>';
              return;
          }

          Object.values(patientDB).forEach((patient, index) => {
              const row = document.createElement('tr');
              row.dataset.status = patient.analysisStatus === 'complete' ? 'Dashboard Ready' : 'Processing';
              row.classList.add('animate-row');
              row.style.animationDelay = `${(index + 1) * 0.1}s`;

              const isReady = patient.analysisStatus === 'complete';
              const statusBadge = isReady 
                  ? '<span class="status-badge status-ready">Analysis Complete</span>'
                  : '<span class="status-badge status-processing">Processing</span>';
              
              const actionButtons = isReady
                  ? `<a href="dashboard_new.html?id=${patient.id}" class="table-action-button btn-primary-action">Report</a>
                     <button class="table-action-button btn-secondary-action" onclick="exportRecord('${patient.id}')">Export</button>
                     <button class="table-action-button btn-delete-action" onclick="confirmDeletePatient('${patient.id}', '${patient.name}')">Delete</button>`
                  : `<button class="table-action-button btn-toggle-status" onclick="toggleStatus(this)">Mark Ready</button>
                     <a href="dashboard_new.html?id=${patient.id}" class="table-action-button btn-primary-action" style="display: none;">Report</a>
                     <button class="table-action-button btn-delete-action" onclick="confirmDeletePatient('${patient.id}', '${patient.name}')">Delete</button>`;

              const card = document.createElement('div');
              card.className = 'patient-card animate-row';
              card.style.animationDelay = `${index * 0.05}s`;
              card.dataset.status = patient.analysisStatus === 'complete' ? 'Dashboard Ready' : 'Processing';
              card.dataset.patientId = patient.id;
              card.dataset.patientName = patient.name;
              card.dataset.age = patient.age;
              card.dataset.diagnosis = patient.diagnosis.condition;

              card.innerHTML = `
                <div class="card-header">
                    <div class="avatar" style="background: linear-gradient(135deg, #60a5fa, #3b82f6)">${patient.initials}</div>
                    <div class="flex-grow">
                        <h3 class="font-bold text-lg searchable" data-original-text="${patient.name}">${patient.name}</h3>
                        <p class="text-sm text-gray-500 searchable" data-original-text="${patient.id}">${patient.id}</p>
                    </div>
                    ${statusBadge}
                </div>
                <div class="flex-grow space-y-3 my-4">
                    <div class="text-sm"><strong class="text-gray-500 w-16 inline-block">Age:</strong> ${patient.age}</div>
                    <div>
                        <strong class="text-gray-500 text-sm block mb-1">Diagnosis:</strong>
                        <div class="diagnosis-cell searchable" data-original-text="${patient.diagnosis.condition} ${patient.diagnosis.details}">
                            <strong>${patient.diagnosis.condition}</strong>
                            <span class="diagnosis-details">${patient.diagnosis.details}</span>
                        </div>
                    </div>
                </div>
                <div class="card-footer mt-auto pt-4 border-t border-gray-200">
                    <div class="action-buttons">${actionButtons}</div>
                </div>
              `;
              grid.appendChild(card);
          });

          // Re-initialize the 'patientCards' array for filtering and sorting
          patientCards = Array.from(document.querySelectorAll(".patient-card"));
      }
    });
  </script>
</body>
</html>
